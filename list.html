<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Create New List - TaskMaster Pro</title>
  
  <!-- PWA Meta Tags -->
  <meta name="description" content="TaskMaster Pro - Create custom task lists and categories" />
  <meta name="theme-color" content="#4f46e5" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="TaskMaster Pro" />
  <meta name="msapplication-TileColor" content="#4f46e5" />
  <meta name="msapplication-config" content="browserconfig.xml" />
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="./manifest.json" />
  
  <!-- OneSignal for iOS Safari notifications -->
  <script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async=""></script>
  
  <!-- Firebase SDK (includes Cloud Messaging for Windows/Desktop) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>
  
  <!-- Firebase Data Management -->
  <script src="./firebase-data.js"></script>
  
  <!-- Favicon and App Icons -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHZpZXdCb3g9IjAgMCA0OCA0OCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHJ4PSIxMiIgZmlsbD0iIzRmNDZlNSIvPgogIDxwYXRoIGQ9Ik0xOCAyNGw0IDRsOC04IiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjMiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8L3N2Zz4K" />
  <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiAgPHJlY3Qgd2lkdGg9IjE5MiIgaGVpZ2h0PSIxOTIiIHJ4PSI0OCIgZmlsbD0iIzRmNDZlNSIvPgogIDxwYXRoIGQ9Ik03MiA5NmwxNiAxNmwzMi0zMiIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIxMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+Cjwvc3ZnPgo=" />
  
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      padding: 20px; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      margin: 0;
    }
    
    /* Navigation Bar */
    .navbar {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 15px 0;
      margin: -20px -20px 30px -20px;
      text-align: center;
      box-shadow: 0 2px 20px rgba(0,0,0,0.1);
    }
    .navbar a {
      color: #4f46e5;
      text-decoration: none;
      margin: 0 20px;
      padding: 8px 16px;
      border-radius: 8px;
      transition: all 0.3s ease;
      font-weight: 500;
    }
    .navbar a:hover {
      background: rgba(79, 70, 229, 0.1);
      transform: translateY(-1px);
    }
    .navbar a.active {
      background: #4f46e5;
      color: white;
      font-weight: 600;
    }
    
    /* Main Container */
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.15);
    }
    
    h1 {
      color: #4f46e5;
      text-align: center;
      margin-bottom: 30px;
      font-size: 2.5em;
      font-weight: 700;
    }
    
    /* Create List Form */
    .create-list-form {
      background: #f8f9ff;
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 40px;
      border: 2px solid #e0e7ff;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-label {
      display: block;
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #d1d5db;
      border-radius: 12px;
      font-size: 16px;
      transition: all 0.3s ease;
      box-sizing: border-box;
    }
    
    .form-input:focus {
      outline: none;
      border-color: #4f46e5;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }
    
    .form-textarea {
      resize: vertical;
      min-height: 80px;
      font-family: inherit;
    }
    
    .create-btn {
      background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
      margin-top: 10px;
    }
    
    .create-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(79, 70, 229, 0.3);
    }
    
    .create-btn:active {
      transform: translateY(0);
    }
    
    /* Custom Lists Display */
    .custom-lists {
      margin-top: 40px;
    }
    
    .custom-lists h2 {
      color: #374151;
      margin-bottom: 20px;
      font-size: 1.5em;
      font-weight: 600;
    }
    
    .lists-container {
      background: #f8f9ff;
      border-radius: 12px;
      padding: 25px;
      border: 2px solid #e0e7ff;
    }
    
    .lists-ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .list-item {
      background: white;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      border-left: 4px solid;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
    }
    
    .list-item:hover {
      transform: translateX(5px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .list-info {
      flex: 1;
    }
    
    .list-item h3 {
      color: #1f2937;
      margin: 0 0 5px 0;
      font-size: 1.1em;
      font-weight: 600;
    }
    
    .list-item p {
      color: #6b7280;
      margin: 0;
      line-height: 1.4;
      font-size: 0.9em;
    }
    
    .delete-btn {
      background: #ef4444;
      color: white;
      border: none;
      padding: 8px 20px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
    }
    
    .delete-btn:hover {
      background: #dc2626;
      transform: scale(1.05);
    }
    
    .delete-btn:active {
      transform: scale(0.98);
    }
    
    /* Success/Error Messages */
    .message {
      padding: 15px 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      font-weight: 500;
    }
    
    .message.success {
      background: #d1fae5;
      color: #065f46;
      border: 2px solid #10b981;
    }
    
    .message.error {
      background: #fee2e2;
      color: #991b1b;
      border: 2px solid #ef4444;
    }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #6b7280;
    }
    
    .empty-state .icon {
      font-size: 4em;
      margin-bottom: 20px;
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      .container {
        margin: 10px;
        padding: 20px;
        border-radius: 16px;
      }
      
      h1 {
        font-size: 2em;
      }
      
      .navbar a {
        margin: 0 10px;
        padding: 6px 12px;
        font-size: 14px;
      }
      
      .list-actions {
        flex-wrap: wrap;
      }
    }
  </style>
</head>
<body>
  <!-- Welcome Message (shown when logged in) -->
  <div id="welcome-message" style="display: none; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 15px 20px; text-align: center; font-weight: 600; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin: -20px -20px 20px -20px;">
    Welcome, <span id="username"></span>!
    <button onclick="signOut()" style="margin-left: 20px; background: rgba(255,255,255,0.2); border: 1px solid white; color: white; padding: 6px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">Sign Out</button>
  </div>
  
  <!-- Guest Mode Notice (shown when not logged in) -->
  <div id="guest-notice" style="display: none; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 12px 20px; text-align: center; font-size: 14px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin: -20px -20px 20px -20px;">
    Guest Mode: Your data will be deleted after 2 hours. <a href="account.html" style="color: white; text-decoration: underline; font-weight: 600;">Create an account</a> to save forever!
  </div>
  
  <!-- Navigation Bar -->
  <nav class="navbar">
    <a href="index.html">TaskMaster Home</a>
    <a href="taskmaster.html">Your Lists</a>
    <a href="list.html" class="active">Create List</a>
  </nav>

  <div class="container">
    <h1>Create New List</h1>
    
    <!-- Success/Error Messages -->
    <div id="messageContainer"></div>
    
    <!-- Create List Form -->
    <div class="create-list-form">
      <form id="createListForm">
        <div class="form-group">
          <label class="form-label" for="listName">List Name *</label>
          <input 
            type="text" 
            id="listName" 
            class="form-input" 
            placeholder="e.g., Home Projects, Work Tasks, Shopping..." 
            required 
            maxlength="50"
          />
        </div>
        
        <div class="form-group">
          <label class="form-label" for="listDescription">Description (Optional)</label>
          <textarea 
            id="listDescription" 
            class="form-input form-textarea" 
            placeholder="Brief description of what this list is for..."
            maxlength="200"
          ></textarea>
        </div>
        
        <div class="form-group">
          <label class="form-label" for="listColor">List Color</label>
          <select id="listColor" class="form-input">
            <option value="#4f46e5">Blue (Default)</option>
            <option value="#10b981">Green</option>
            <option value="#f59e0b">Orange</option>
            <option value="#ef4444">Red</option>
            <option value="#8b5cf6">Purple</option>
            <option value="#06b6d4">Cyan</option>
            <option value="#84cc16">Lime</option>
            <option value="#f97316">Orange Red</option>
            <option value="#ec4899">Pink</option>
            <option value="#64748b">Gray</option>
          </select>
        </div>
        
        <button type="submit" class="create-btn">
          Create List
        </button>
      </form>
    </div>
    
    <!-- Custom Lists Display -->
    <div class="custom-lists">
      <h2>Your Custom Lists</h2>
      <div id="customListsContainer">
        <!-- Custom lists will be populated here -->
      </div>
    </div>
  </div>

  <script>
    // Generate or get unique user ID for this browser/device
    function getUserId() {
      let userId = localStorage.getItem('taskmaster_user_id');
      if (!userId) {
        // Generate unique user ID: timestamp + random string
        userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('taskmaster_user_id', userId);
        console.log('ðŸ†” New user ID generated:', userId);
      }
      return userId;
    }
    
    // Custom lists storage - user-specific
    function getCustomListsKey() {
      return `taskmaster_custom_lists_${getUserId()}`;
    }
    
    function getCustomSectionNamesKey() {
      return `taskmaster_custom_section_names_${getUserId()}`;
    }
    
    // Get custom lists from Firestore or localStorage (user-specific)
    async function getCustomLists() {
      // Use Firebase function from firebase-data.js if available
      if (typeof loadCustomLists === 'function') {
        return await loadCustomLists();
      }
      // Fallback to localStorage
      const lists = localStorage.getItem(getCustomListsKey());
      return lists ? JSON.parse(lists) : [];
    }
    
    // Save custom lists to Firestore or localStorage (user-specific)
    async function saveCustomListsLocal(lists) {
      // Use Firebase function from firebase-data.js if available
      if (typeof saveCustomLists === 'function') {
        await saveCustomLists(lists);
      } else {
        // Fallback to localStorage
        localStorage.setItem(getCustomListsKey(), JSON.stringify(lists));
      }
    }
    
    // Generate unique ID for lists
    function generateListId() {
      return 'custom_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }
    
    // Show message to user
    function showMessage(text, type = 'success') {
      const container = document.getElementById('messageContainer');
      const message = document.createElement('div');
      message.className = `message ${type}`;
      message.textContent = text;
      
      container.innerHTML = '';
      container.appendChild(message);
      
      // Auto-hide message after 5 seconds
      setTimeout(() => {
        message.style.opacity = '0';
        setTimeout(() => {
          if (message.parentNode) {
            message.parentNode.removeChild(message);
          }
        }, 300);
      }, 5000);
    }
    
    // Create new custom list
    async function createCustomList(name, description, color) {
      const lists = await getCustomLists();
      
      // Check if list name already exists
      if (lists.find(list => list.name.toLowerCase() === name.toLowerCase())) {
        showMessage('A list with this name already exists!', 'error');
        return false;
      }
      
      const newList = {
        id: generateListId(),
        name: name.trim(),
        description: description.trim(),
        color: color,
        createdAt: new Date().toISOString(),
        taskCount: 0
      };
      
      lists.push(newList);
      await saveCustomListsLocal(lists);
      
      // Update the sections array in the main app
      await updateMainAppSections();
      
      showMessage(`List "${name}" created successfully and synced to cloud!`);
      await displayCustomLists();
      return true;
    }
    
    // Delete custom list
    async function deleteCustomList(listId) {
      const lists = await getCustomLists();
      const list = lists.find(l => l.id === listId);
      
      if (!list) return;
      
      // Confirmation prompt with list name
      if (!confirm(`Are you sure you want to delete "${list.name}"?\n\nThis will permanently remove the list and cannot be undone.`)) {
        return;
      }
      
      const filteredLists = lists.filter(list => list.id !== listId);
      await saveCustomListsLocal(filteredLists);
      
      // Update the sections array in the main app
      await updateMainAppSections();
      
      showMessage(`List "${list.name}" deleted successfully and synced to cloud!`);
      await displayCustomLists();
    }
    
    // Edit custom list
    async function editCustomList(listId) {
      const lists = await getCustomLists();
      const list = lists.find(l => l.id === listId);
      
      if (!list) return;
      
      const newName = prompt('Enter new list name:', list.name);
      if (!newName || newName.trim() === '') return;
      
      // Check if new name conflicts with existing lists
      if (lists.find(l => l.id !== listId && l.name.toLowerCase() === newName.toLowerCase())) {
        alert('A list with this name already exists!');
        return;
      }
      
      const newDescription = prompt('Enter new description (optional):', list.description);
      
      list.name = newName.trim();
      list.description = newDescription ? newDescription.trim() : '';
      
      await saveCustomListsLocal(lists);
      await updateMainAppSections();
      
      showMessage(`List "${list.name}" updated successfully and synced to cloud!`);
      await displayCustomLists();
    }
    
    // Update the main app's SECTIONS array (user-specific)
    async function updateMainAppSections() {
      const customLists = await getCustomLists();
      const customListNames = customLists.map(list => list.name);
      
      // Store custom list names for the main app to use (user-specific)
      localStorage.setItem(getCustomSectionNamesKey(), JSON.stringify(customListNames));
    }
    
    // Display custom lists
    async function displayCustomLists() {
      const container = document.getElementById('customListsContainer');
      const lists = await getCustomLists();
      
      if (lists.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="icon"></div>
            <h3>No custom lists yet</h3>
            <p>Create your first custom list above to get started!</p>
          </div>
        `;
        return;
      }
      
      const listItems = lists.map(list => `
        <li class="list-item" style="border-left-color: ${list.color}">
          <div class="list-info">
            <h3>â€¢ ${list.name}</h3>
            <p>${list.description || 'No description'}</p>
          </div>
          <button class="delete-btn" onclick="deleteCustomList('${list.id}')">
            Delete List
          </button>
        </li>
      `).join('');
      
      container.innerHTML = `
        <div class="lists-container">
          <ul class="lists-ul">
            ${listItems}
          </ul>
        </div>
      `;
    }
    
    // View list tasks (redirect to taskmaster.html with focus on this list)
    async function viewList(listId) {
      const lists = await getCustomLists();
      const list = lists.find(l => l.id === listId);
      
      if (list) {
        // Store the list to focus on
        sessionStorage.setItem('focusList', list.name);
        window.location.href = 'taskmaster.html';
      }
    }
    
    // Form submission handler
    document.getElementById('createListForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const name = document.getElementById('listName').value.trim();
      const description = document.getElementById('listDescription').value.trim();
      const color = document.getElementById('listColor').value;
      
      if (!name) {
        showMessage('Please enter a list name!', 'error');
        return;
      }
      
      if (await createCustomList(name, description, color)) {
        // Clear form
        this.reset();
      }
    });
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      // Lists will be loaded after authentication completes via onAuthStateChanged
      console.log('Page loaded, waiting for authentication...');
    });
  </script>
  
  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyC1S6U4E_IIAw5csnapl8ZoIyBS_Lv5k2A",
      authDomain: "taskmaster-pro-bf98a.firebaseapp.com",
      projectId: "taskmaster-pro-bf98a",
      storageBucket: "taskmaster-pro-bf98a.firebasestorage.app",
      messagingSenderId: "47778628154",
      appId: "1:47778628154:web:eddd6a64147d917fcb6b03",
      measurementId: "G-JERNL4E72Z"
    };

    // Initialize Firebase
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Set auth persistence to LOCAL
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch((error) => {
      console.error('Error setting auth persistence:', error);
    });

    // Check authentication state
    auth.onAuthStateChanged(async (user) => {
      const welcomeMsg = document.getElementById('welcome-message');
      const guestNotice = document.getElementById('guest-notice');
      const usernameEl = document.getElementById('username');
      
      if (user) {
        const displayName = user.displayName || user.email.split('@')[0];
        usernameEl.textContent = displayName;
        welcomeMsg.style.display = 'block';
        guestNotice.style.display = 'none';
        window.currentUser = user;
        window.isGuestMode = false;
        
        // Set user presence to online
        await setUserPresence(user, true);
        
        // Load lists from Firebase after authentication
        console.log('User authenticated, loading lists from Firebase...');
        await displayCustomLists();
      } else {
        welcomeMsg.style.display = 'none';
        guestNotice.style.display = 'block';
        window.currentUser = null;
        window.isGuestMode = true;
        
        // Load local lists for guest
        console.log('Guest mode, loading local lists...');
        await displayCustomLists();
      }
    });

    // Sign out function
    async function signOut() {
      const user = auth.currentUser;
      if (user) {
        // Wait for presence to be updated before signing out
        await setUserPresence(user, false);
      }
      
      auth.signOut().then(() => {
        alert('Signed out successfully!');
        window.location.href = 'index.html';
      });
    }
    
    // Set user online/offline presence
    function setUserPresence(user, online) {
      if (!user) return Promise.resolve();
      
      return db.collection('presence').doc(user.uid).set({
        online: online,
        username: user.displayName || user.email.split('@')[0],
        email: user.email,
        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true }).catch(error => console.error('Error updating presence:', error));
    }
    
    // Heartbeat: Update lastSeen every 30 seconds
    let heartbeatInterval;
    
    auth.onAuthStateChanged((user) => {
      // Clear any existing heartbeat
      if (heartbeatInterval) clearInterval(heartbeatInterval);
      
      if (user) {
        // Update presence immediately
        setUserPresence(user, true);
        
        // Set up heartbeat to update lastSeen every 30 seconds
        heartbeatInterval = setInterval(() => {
          db.collection('presence').doc(user.uid).update({
            lastSeen: firebase.firestore.FieldValue.serverTimestamp()
          }).catch(error => console.error('Heartbeat error:', error));
        }, 30000);
      }
    });
    
    // Mark user offline when closing tab/browser (best effort)
    window.addEventListener('beforeunload', () => {
      const user = auth.currentUser;
      if (user) {
        // Use synchronous update attempt
        navigator.sendBeacon && db.collection('presence').doc(user.uid).update({
          online: false,
          lastSeen: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
    });
  </script>
</body>
</html>