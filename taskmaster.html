<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Your Lists - TaskMaster Pro</title>
  
  <!-- PWA Meta Tags -->
  <meta name="description" content="TaskMaster Pro - Master your tasks, dominate your day with advanced reminders and notifications" />
  <meta name="theme-color" content="#4f46e5" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="TaskMaster Pro" />
  <meta name="msapplication-TileColor" content="#4f46e5" />
  <meta name="msapplication-config" content="browserconfig.xml" />
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="./manifest.json" />
  
  <!-- OneSignal for iOS notifications -->
  <script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async=""></script>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  
  <!-- Firebase Data Management -->
  <script src="./firebase-data.js"></script>
  
  <!-- Favicon and App Icons -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHZpZXdCb3g9IjAgMCA0OCA0OCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHJ4PSIxMiIgZmlsbD0iIzRmNDZlNSIvPgogIDxwYXRoIGQ9Ik0xOCAyNGw0IDRsOC04IiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjMiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8L3N2Zz4K" />
  <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiAgPHJlY3Qgd2lkdGg9IjE5MiIgaGVpZ2h0PSIxOTIiIHJ4PSI0OCIgZmlsbD0iIzRmNDZlNSIvPgogIDxwYXRoIGQ9Ik03MiA5NmwxNiAxNmwzMi0zMiIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIxMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+Cjwvc3ZnPgo=" />
  
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f5f5f5; }
    
    /* Navigation Bar */
    .navbar {
      background: #4f46e5;
      padding: 15px 0;
      margin: -20px -20px 20px -20px;
      text-align: center;
    }
    .navbar a {
      color: white;
      text-decoration: none;
      margin: 0 20px;
      padding: 8px 16px;
      border-radius: 4px;
      transition: background 0.3s;
    }
    .navbar a:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    .navbar a.active {
      background: rgba(255, 255, 255, 0.3);
      font-weight: bold;
    }
    
    /* Task styling */
    summary { font-weight: bold; font-size: 1.2em; cursor: pointer; margin-top: 1em; }
    .task-section { padding: 10px 20px; background: #fff; border: 1px solid #ccc; margin-bottom: 15px; }
    input, button, select { display: block; margin: 6px 0; padding: 6px; width: 95%; max-width: 400px; }
    ul { margin-top: 10px; padding-left: 20px; }
    li { margin-bottom: 6px; }
    .form-label { font-size: 0.9em; font-weight: bold; margin-top: 10px; margin-bottom: 2px; }
  </style>
</head>
<body>
  <!-- Welcome Message (shown when logged in) -->
  <div id="welcome-message" style="display: none; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 15px 20px; text-align: center; font-weight: 600; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin: -20px -20px 20px -20px;">
    Welcome, <span id="username"></span>!
    <button onclick="signOut()" style="margin-left: 20px; background: rgba(255,255,255,0.2); border: 1px solid white; color: white; padding: 6px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">Sign Out</button>
  </div>
  
  <!-- Guest Mode Notice (shown when not logged in) -->
  <div id="guest-notice" style="display: none; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 12px 20px; text-align: center; font-size: 14px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin: -20px -20px 20px -20px;">
    Guest Mode: Your data will be deleted after 2 hours. <a href="account.html" style="color: white; text-decoration: underline; font-weight: 600;">Create an account</a> to save forever!
  </div>
  
  <!-- Navigation Bar -->
  <nav class="navbar">
    <a href="index.html">TaskMaster Home</a>
    <a href="taskmaster.html" class="active">Your Lists</a>
    <a href="list.html">Create List</a>
    <a href="options.html">Options</a>
    <a id="admin-link" href="admin.html" style="display: none; color: #f59e0b; font-weight: 700;">Admin Dashboard</a>
  </nav>

  <h1>Your Task Lists</h1>
  
  <!-- Task Sync Information -->
  <div class="sync-info" style="background: #e3f2fd; border: 1px solid #2196f3; border-radius: 8px; padding: 15px; margin-bottom: 20px; font-size: 14px;">
    Your lists you create appear here.
    If no lists are created yet, you can create one.
  </div>
  
  <div id="sections" role="region" aria-label="Todo Lists"></div>

  <script src="todo.js"></script>
  
  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyC1S6U4E_IIAw5csnapl8ZoIyBS_Lv5k2A",
      authDomain: "taskmaster-pro-bf98a.firebaseapp.com",
      projectId: "taskmaster-pro-bf98a",
      storageBucket: "taskmaster-pro-bf98a.firebasestorage.app",
      messagingSenderId: "47778628154",
      appId: "1:47778628154:web:eddd6a64147d917fcb6b03",
      measurementId: "G-JERNL4E72Z"
    };

    // Initialize Firebase
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.firestore();
    window.db = db; // Make db globally accessible

    // Set auth persistence to LOCAL
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch((error) => {
      console.error('Error setting auth persistence:', error);
    });

    // Check authentication state
    auth.onAuthStateChanged(async (user) => {
      const welcomeMsg = document.getElementById('welcome-message');
      const guestNotice = document.getElementById('guest-notice');
      const usernameEl = document.getElementById('username');
      const adminLink = document.getElementById('admin-link');
      
      if (user) {
        const displayName = user.displayName || user.email.split('@')[0];
        usernameEl.textContent = displayName;
        welcomeMsg.style.display = 'block';
        guestNotice.style.display = 'none';
        window.currentUser = user;
        window.isGuestMode = false;
        
        // Set user presence to online
        await setUserPresence(user, true);
        
        // Reload sections from Firebase after authentication
        console.log('User authenticated, loading lists from Firebase...');
        if (typeof createSections === 'function') {
          await createSections();
        }
        
        // Show admin link if user is admin
        if (adminLink) {
          const userEmail = user.email ? user.email.toLowerCase().trim() : '';
          const adminEmail = 'fluffyfighter23@gmx.de';
          if (userEmail === adminEmail) {
            adminLink.style.display = 'inline-block';
          }
        }
      } else {
        welcomeMsg.style.display = 'none';
        guestNotice.style.display = 'block';
        window.currentUser = null;
        window.isGuestMode = true;
        
        // Reload sections for guest mode
        console.log('Guest mode, loading local lists...');
        if (typeof createSections === 'function') {
          await createSections();
        }
      }
    });

    // Sign out function
    async function signOut() {
      const user = auth.currentUser;
      if (user) {
        // Wait for presence to be updated before signing out
        await setUserPresence(user, false);
      }
      
      auth.signOut().then(() => {
        alert('Signed out successfully!');
        window.location.reload();
      });
    }
    
    // Set user online/offline presence
    function setUserPresence(user, online) {
      if (!user) return Promise.resolve();
      
      return db.collection('presence').doc(user.uid).set({
        online: online,
        username: user.displayName || user.email.split('@')[0],
        email: user.email,
        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true }).catch(error => console.error('Error updating presence:', error));
    }
    
    // Heartbeat: Update lastSeen every 30 seconds
    let heartbeatInterval;
    
    auth.onAuthStateChanged((user) => {
      // Clear any existing heartbeat
      if (heartbeatInterval) clearInterval(heartbeatInterval);
      
      if (user) {
        // Update presence immediately
        setUserPresence(user, true);
        
        // Set up heartbeat to update lastSeen every 30 seconds
        heartbeatInterval = setInterval(() => {
          db.collection('presence').doc(user.uid).update({
            lastSeen: firebase.firestore.FieldValue.serverTimestamp()
          }).catch(error => console.error('Heartbeat error:', error));
        }, 30000);
      }
    });
    
    // Mark user offline when closing tab/browser (best effort)
    window.addEventListener('beforeunload', () => {
      const user = auth.currentUser;
      if (user) {
        // Use synchronous update attempt
        navigator.sendBeacon && db.collection('presence').doc(user.uid).update({
          online: false,
          lastSeen: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
    });
  </script>

</body>
</html>