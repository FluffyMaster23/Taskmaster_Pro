<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Options - TaskMaster Pro</title>
  
  <!-- PWA Meta Tags -->
  <meta name="description" content="TaskMaster Pro - Master your tasks, dominate your day with advanced reminders and notifications" />
  <meta name="theme-color" content="#4f46e5" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="TaskMaster Pro" />
  <meta name="msapplication-TileColor" content="#4f46e5" />
  <meta name="msapplication-config" content="browserconfig.xml" />
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="./manifest.json" />
  
  <!-- OneSignal for iOS Safari notifications -->
  <script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async=""></script>
  
  <!-- Firebase SDK (includes Cloud Messaging for Windows/Desktop) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>
  
  <!-- Favicon and App Icons -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHZpZXdCb3g9IjAgMCA0OCA0OCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHJ4PSIxMiIgZmlsbD0iIzRmNDZlNSIvPgogIDxwYXRoIGQ9Ik0xOCAyNGw0IDRsOC04IiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjMiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8L3N2Zz4K" />
  <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiAgPHJlY3Qgd2lkdGg9IjE5MiIgaGVpZ2h0PSIxOTIiIHJ4PSI0OCIgZmlsbD0iIzRmNDZlNSIvPgogIDxwYXRoIGQ9Ik03MiA5NmwxNiAxNmwzMi0zMiIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIxMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+Cjwvc3ZnPgo=" />
  
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f5f5f5; }
    
    /* Navigation Bar */
    .navbar {
      background: #4f46e5;
      padding: 15px 0;
      margin: -20px -20px 20px -20px;
      text-align: center;
    }
    .navbar a {
      color: white;
      text-decoration: none;
      margin: 0 20px;
      padding: 8px 16px;
      border-radius: 4px;
      transition: background 0.3s;
    }
    .navbar a:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    .navbar a.active {
      background: rgba(255, 255, 255, 0.3);
      font-weight: bold;
    }
    
    /* Options styling */
    .options-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .options-section h2 {
      margin-top: 0;
      color: #4f46e5;
      border-bottom: 2px solid #e5e7eb;
      padding-bottom: 10px;
    }
    label {
      display: block;
      font-weight: bold;
      margin: 15px 0 5px 0;
      color: #374151;
    }
    select {
      display: block;
      margin: 5px 0 15px 0;
      padding: 8px;
      width: 100%;
      max-width: 400px;
      border: 2px solid #d1d5db;
      border-radius: 4px;
      font-size: 14px;
    }
    select:focus {
      outline: none;
      border-color: #4f46e5;
    }
    .save-btn {
      background: #10b981;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 15px;
    }
    .save-btn:hover {
      background: #059669;
    }
    .status-message {
      margin-top: 10px;
      padding: 8px;
      border-radius: 4px;
      display: none;
    }
    .status-message.success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #a7f3d0;
    }
  </style>
</head>
<body>
  <!-- Welcome Message (shown when logged in) -->
  <div id="welcome-message" style="display: none; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 15px 20px; text-align: center; font-weight: 600; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin: -20px -20px 20px -20px;">
    Welcome, <span id="username"></span>!
    <button onclick="signOut()" style="margin-left: 20px; background: rgba(255,255,255,0.2); border: 1px solid white; color: white; padding: 6px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">Sign Out</button>
  </div>
  
  <!-- Guest Mode Notice (shown when not logged in) -->
  <div id="guest-notice" style="display: none; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 12px 20px; text-align: center; font-size: 14px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin: -20px -20px 20px -20px;">
    Guest Mode: Your data will be deleted after 2 hours. <a href="account.html" style="color: white; text-decoration: underline; font-weight: 600;">Create an account</a> to save forever!
  </div>
  
  <!-- Navigation Bar -->
  <nav class="navbar">
    <a href="index.html">TaskMaster Home</a>
    <a href="taskmaster.html">Your Lists</a>
    <a href="options.html" class="active">Options</a>
  </nav>

  <h1>TaskMaster Pro Options</h1>
  
  <div class="options-section">
    <h2>User & Privacy Info</h2>
    <p><strong>Your User ID:</strong> <span id="currentUserId" style="font-family: monospace; color: #4f46e5; background: #f3f4f6; padding: 2px 6px; border-radius: 4px;">Loading...</span></p>
    <p style="font-size: 0.9em; color: #6b7280; margin-top: 5px;">
      This unique ID identifies your browser/device. Your custom lists and tasks are stored locally and only visible to this user ID. 
      Other users on different devices will have their own separate lists.
    </p>
    <p style="font-size: 0.9em; color: #059669; margin-top: 10px;">
      <strong>Privacy:</strong> All data is stored locally on your device only. No data is sent to external servers.
    </p>
  </div>
  
  <div class="options-section">
    <h2>Voice & Speech Settings</h2>
    
    <label for="voiceSelect">Choose Voice:</label>
    <select id="voiceSelect" aria-label="Choose voice" onchange="autoSaveVoiceSettings()">
      <option value="">Loading voices...</option>
    </select>

    <label for="speechRateSelect">Speech Speed:</label>
    <select id="speechRateSelect" aria-label="Choose speech speed" onchange="autoSaveVoiceSettings()">
      <option value="0.5">Very Slow (0.5x)</option>
      <option value="0.75">Slow (0.75x)</option>
      <option value="1" selected>Normal (1x)</option>
      <option value="1.25">Fast (1.25x)</option>
      <option value="1.5">Very Fast (1.5x)</option>
      <option value="1.75">Super Fast (1.75x)</option>
      <option value="2">Maximum (2x)</option>
    </select>

    <button class="save-btn" onclick="saveVoiceSettings()">Save Voice Settings</button>
    <div id="saveStatus" class="status-message"></div>
  </div>

  <div class="options-section">
    <h2>Notification Settings</h2>
    <p><strong>Status:</strong> <span id="notificationStatus">Checking...</span></p>
    
    <label for="enableNotifications" style="margin-top: 20px;">
      <input type="checkbox" id="enableNotifications" style="width: auto; margin-right: 10px;">
      Enable Push Notifications
    </label>
    <p style="font-size: 0.9em; color: #6b7280; margin-top: 5px;">Check this box to trigger the notification permission prompt and enable push notifications for task reminders.</p>
    
    <p style="margin-top: 15px;">Notifications are automatically configured based on your platform (iOS uses OneSignal, desktop uses native notifications).</p>
    <p style="font-size: 0.9em; color: #f59e0b; margin-top: 10px;"><strong>Note for iOS:</strong> Notifications require the app to be deployed on HTTPS. Local development (localhost) may not support OneSignal notifications on iOS devices.</p>
    
    <!-- Test Notification Button -->
    <button onclick="testNotification()" style="margin-top: 15px; background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
      Test Notification
    </button>
    <p style="font-size: 0.8em; color: #6b7280; margin-top: 5px;">Click to test if notifications are working on your device.</p>
    
    <!-- Debug Button for iOS -->
    <button onclick="debugNotifications()" style="margin-top: 10px; background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
      Debug Notifications
    </button>
    <p style="font-size: 0.8em; color: #6b7280; margin-top: 5px;">View detailed notification status and troubleshooting info.</p>
  </div>

  <!-- Delete Account Section -->
  <div class="options-section" style="border: 2px solid #ef4444; background: #fef2f2;">
    <h2 style="color: #dc2626;">Delete Account</h2>
    <p style="color: #7f1d1d;">
      <strong>Warning:</strong> This will permanently delete your account and all associated data including tasks, lists, and settings. This action cannot be undone.
    </p>
    <button onclick="deleteAccount()" style="margin-top: 15px; background: #dc2626; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 600;">
      Delete My Account
    </button>
  </div>

  <script src="todo.js"></script>
  <script>
    // Enhanced test notification function for iOS debugging
    function testNotification() {
      console.log('Testing notification...');
      
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                    (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      const isFirefox = navigator.userAgent.includes('Firefox');
      const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
      const isHTTPS = location.protocol === 'https:';
      
      console.log('Platform detection:', { 
        isIOS, isFirefox, isSafari, isHTTPS,
        userAgent: navigator.userAgent,
        protocol: location.protocol,
        hostname: location.hostname
      });
      
      if (isIOS) {
        console.log('iOS detected - starting comprehensive notification test...');
        
        // Method 1: Try native Web Notifications first (iOS 16.4+ with Firefox/Chrome)
        if ('Notification' in window && !isSafari) {
          console.log('Testing native Web Notifications on iOS...');
          console.log('Current permission:', Notification.permission);
          
          if (Notification.permission === 'granted') {
            console.log('Native permission already granted, sending test notification...');
            try {
              const notification = new Notification('TaskMaster Pro Test', {
                body: 'Native iOS notification is working!',
                icon: '/favicon.ico',
                badge: '/favicon.ico',
                tag: 'taskmaster-test',
                requireInteraction: false,
                silent: false,
                timestamp: Date.now()
              });
              
              notification.onclick = function() {
                console.log('Notification clicked');
                window.focus();
                notification.close();
              };
              
              // Auto-close after 8 seconds
              setTimeout(() => {
                notification.close();
              }, 8000);
              
              alert('âœ… Native test notification sent! Check your notification center.');
              return;
            } catch (error) {
              console.error('âŒ Native notification failed:', error);
              alert('âŒ Native notification failed: ' + error.message);
            }
          } else if (Notification.permission === 'default') {
            console.log('Requesting native notification permission...');
            Notification.requestPermission().then(function(permission) {
              console.log('Permission result:', permission);
              if (permission === 'granted') {
                alert('âœ… Native notification permission granted! Click Test again.');
              } else {
                alert('âŒ Native notification permission denied. Try enabling in iOS Settings.');
              }
            }).catch(function(error) {
              console.error('âŒ Permission request failed:', error);
              alert('âŒ Permission request failed: ' + error.message);
            });
            return;
          } else {
            console.log('âŒ Native notifications denied');
            alert('âŒ Native notifications denied. Please enable in iOS Settings â†’ Safari â†’ Notifications.');
          }
        }
        
        // Method 2: Try OneSignal for Safari or as fallback
        if (window.OneSignal && (isSafari || Notification.permission !== 'granted')) {
          console.log('Testing OneSignal on iOS...');
          
          // Wait for OneSignal to be ready
          window.OneSignal.push(function() {
            console.log('OneSignal is ready, checking status...');
            
            // Get detailed OneSignal status
            window.OneSignal.isPushNotificationsEnabled(function(isEnabled) {
              console.log('OneSignal enabled:', isEnabled);
              
              if (isEnabled) {
                console.log('âœ… OneSignal is enabled, sending test notification...');
                
                window.OneSignal.sendSelfNotification(
                  "ðŸ§ª TaskMaster Pro Test",
                  "OneSignal iOS notification is working! âœ…",
                  window.location.href,
                  "/favicon.ico"
                ).then(function() {
                  console.log('âœ… OneSignal test notification sent successfully');
                  alert('âœ… OneSignal test notification sent! Check your notification center.');
                }).catch(function(error) {
                  console.error('âŒ OneSignal test failed:', error);
                  alert('âŒ OneSignal test failed: ' + error.message + '\n\nTry: iOS Settings â†’ Notifications â†’ Allow notifications for this site');
                });
              } else {
                console.log('âš ï¸ OneSignal not enabled, attempting to subscribe...');
                
                // Force OneSignal registration to resolve "pending setup"
                window.OneSignal.registerForPushNotifications().then(function() {
                  console.log('âœ… OneSignal registration successful');
                  
                  // Wait a moment for the subscription to be active, then try sending again
                  setTimeout(() => {
                    window.OneSignal.isPushNotificationsEnabled(function(isNowEnabled) {
                      if (isNowEnabled) {
                        console.log('âœ… OneSignal now enabled, sending test notification...');
                        window.OneSignal.sendSelfNotification(
                          "TaskMaster Pro Test",
                          "OneSignal iOS notification is now working! âœ…",
                          window.location.href,
                          "/favicon.ico"
                        ).then(function() {
                          alert('âœ… OneSignal setup complete! Test notification sent!');
                        }).catch(function(error) {
                          console.error('âŒ Test after registration failed:', error);
                          alert('âœ… OneSignal registration successful! Please try the test button again.');
                        });
                      } else {
                        alert('âœ… OneSignal registration successful! Please try the test button again.');
                      }
                    });
                  }, 2000);
                  
                }).catch(function(error) {
                  console.error('âŒ OneSignal registration failed:', error);
                  
                  // Show detailed troubleshooting based on the specific error
                  let troubleshooting = `âŒ OneSignal registration failed: ${error.message}\n\n`;
                  
                  if (error.message.includes('not supported')) {
                    troubleshooting += `Browser not supported:\nâ€¢ Try using Safari on iOS\nâ€¢ Ensure iOS 12+ for OneSignal support`;
                  } else if (error.message.includes('permission')) {
                    troubleshooting += `Permission issue:\nâ€¢ iOS Settings â†’ Safari â†’ Notifications â†’ Allow\nâ€¢ Refresh page and try again`;
                  } else if (error.message.includes('https')) {
                    troubleshooting += `HTTPS required:\nâ€¢ OneSignal requires secure connection\nâ€¢ Try on deployed site instead of localhost`;
                  } else {
                    troubleshooting += `General troubleshooting:\n1. Make sure you're using Safari on iOS\n2. Enable: iOS Settings â†’ Safari â†’ Notifications\n3. Allow notifications when prompted\n4. Ensure HTTPS connection\n5. Try refreshing the page completely`;
                  }
                  
                  troubleshooting += `\n\nCurrent: ${isHTTPS ? 'HTTPS âœ…' : 'HTTP âŒ'} | ${isSafari ? 'Safari âœ…' : 'Not Safari âŒ'}`;
                  
                  alert(troubleshooting);
                });
              }
            });
            
            // Also check user ID for debugging
            window.OneSignal.getUserId(function(userId) {
              console.log('OneSignal User ID:', userId);
            });
            
            // Check subscription details
            window.OneSignal.getSubscription(function(subscription) {
              console.log('OneSignal Subscription:', subscription);
            });
          });
        } else if (!window.OneSignal) {
          console.log('âŒ OneSignal not available');
          alert('âŒ OneSignal not available. Make sure:\n1. You\'re on HTTPS\n2. The page has fully loaded\n3. OneSignal SDK is properly loaded');
        }
        
        // If nothing worked, show comprehensive help
        setTimeout(() => {
          if (!window.testNotificationSent) {
            const helpMessage = `iOS Notification Troubleshooting:

ðŸ“± For iOS 16.4+ (Firefox/Chrome):
â€¢ Enable: iOS Settings â†’ [Browser] â†’ Notifications
â€¢ Website permissions: Allow notifications when prompted

ðŸ§­ For iOS Safari:
â€¢ Enable: iOS Settings â†’ Safari â†’ Notifications  
â€¢ Website permissions: Allow notifications for this site

ðŸ”§ General troubleshooting:
â€¢ Ensure you're on HTTPS (https://)
â€¢ Refresh the page completely
â€¢ Try in private/incognito mode
â€¢ Check iOS Settings â†’ Notifications â†’ [App/Browser]

Current: ${isHTTPS ? 'HTTPS âœ…' : 'HTTP âŒ'} | ${isSafari ? 'Safari' : isFirefox ? 'Firefox' : 'Other'}`;
            
            console.log(helpMessage);
          }
        }, 2000);
        
      } else {
        // Desktop/non-iOS testing
        console.log('ðŸ’» Desktop detected - testing native notifications...');
        
        if ('Notification' in window) {
          if (Notification.permission === 'granted') {
            const notification = new Notification('ðŸ§ª TaskMaster Pro Test', {
              body: 'Desktop notification is working! âœ…',
              icon: '/favicon.ico'
            });
            
            setTimeout(() => notification.close(), 5000);
            alert('âœ… Desktop test notification sent!');
          } else {
            Notification.requestPermission().then(function(permission) {
              if (permission === 'granted') {
                alert('âœ… Desktop notification permission granted! Try the test again.');
              } else {
                alert('âŒ Desktop notification permission denied.');
              }
            });
          }
        } else {
          alert('âŒ Notifications not supported in this browser.');
        }
      }
    }
    
    // Debug function to show detailed notification status
    function debugNotifications() {
      console.log('ðŸ” Starting notification debug...');
      
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                    (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      const isFirefox = navigator.userAgent.includes('Firefox');
      const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
      const isHTTPS = location.protocol === 'https:';
      
      let debugInfo = `ðŸ” NOTIFICATION DEBUG REPORT\n\n`;
      debugInfo += `ðŸ“± Platform: ${isIOS ? 'iOS' : 'Desktop'}\n`;
      debugInfo += `ðŸŒ Browser: ${isSafari ? 'Safari' : isFirefox ? 'Firefox' : 'Other'}\n`;
      debugInfo += `ðŸ”’ Protocol: ${location.protocol} (${isHTTPS ? 'Secure âœ…' : 'Not Secure âŒ'})\n`;
      debugInfo += `ðŸ  Hostname: ${location.hostname}\n`;
      debugInfo += `ðŸ‘¤ User Agent: ${navigator.userAgent}\n\n`;
      
      // Check native notification support
      if ('Notification' in window) {
        debugInfo += `ðŸ”” Native Notifications: Supported âœ…\n`;
        debugInfo += `ðŸ“Š Permission: ${Notification.permission}\n`;
      } else {
        debugInfo += `ðŸ”” Native Notifications: Not Supported âŒ\n`;
      }
      
      // Check service worker support
      if ('serviceWorker' in navigator) {
        debugInfo += `âš™ï¸ Service Worker: Supported âœ…\n`;
        navigator.serviceWorker.getRegistrations().then(registrations => {
          console.log('Service Worker Registrations:', registrations);
        });
      } else {
        debugInfo += `âš™ï¸ Service Worker: Not Supported âŒ\n`;
      }
      
      // Check OneSignal status
      if (window.OneSignal) {
        debugInfo += `ðŸ”¥ OneSignal: Available âœ…\n`;
        
        window.OneSignal.push(function() {
          window.OneSignal.isPushNotificationsEnabled(function(isEnabled) {
            debugInfo += `ðŸ“¡ OneSignal Enabled: ${isEnabled ? 'Yes âœ…' : 'No âŒ'}\n`;
            
            window.OneSignal.getUserId(function(userId) {
              debugInfo += `ðŸ‘¤ OneSignal User ID: ${userId || 'None'}\n`;
              
              window.OneSignal.getSubscription(function(subscription) {
                debugInfo += `ðŸ“§ OneSignal Subscription: ${subscription ? 'Active' : 'None'}\n`;
                
                if (isIOS) {
                  debugInfo += `\nðŸŽ iOS TROUBLESHOOTING:\n`;
                  if (isSafari) {
                    debugInfo += `â€¢ Using Safari âœ…\n`;
                    debugInfo += `â€¢ Enable: iOS Settings â†’ Safari â†’ Notifications\n`;
                    debugInfo += `â€¢ Allow notifications when prompted\n`;
                    if (!isHTTPS) {
                      debugInfo += `â€¢ âš ï¸ HTTPS required for OneSignal on iOS\n`;
                    }
                  } else {
                    debugInfo += `â€¢ Using ${isFirefox ? 'Firefox' : 'Other Browser'}\n`;
                    debugInfo += `â€¢ iOS 16.4+ required for native notifications\n`;
                    debugInfo += `â€¢ Enable: iOS Settings â†’ [Browser] â†’ Notifications\n`;
                  }
                } else {
                  debugInfo += `\nðŸ’» DESKTOP TROUBLESHOOTING:\n`;
                  debugInfo += `â€¢ Allow notifications when prompted\n`;
                  debugInfo += `â€¢ Check browser notification settings\n`;
                  debugInfo += `â€¢ Ensure site permissions allow notifications\n`;
                }
                
                debugInfo += `\nðŸ“ Console logs show more details.`;
                
                // Show in alert and log to console
                alert(debugInfo);
                console.log(debugInfo);
              });
            });
          });
        });
      } else {
        debugInfo += `ðŸ”¥ OneSignal: Not Available âŒ\n`;
        debugInfo += `â€¢ Check if HTTPS is enabled\n`;
        debugInfo += `â€¢ Ensure OneSignal SDK loaded correctly\n`;
        
        alert(debugInfo);
        console.log(debugInfo);
      }
    }
    
    // Auto-save voice settings when changed (silent auto-save, no voice announcements)
    function autoSaveVoiceSettings() {
      const voiceSelect = document.getElementById('voiceSelect');
      const speechRateSelect = document.getElementById('speechRateSelect');
      
      if (voiceSelect && speechRateSelect) {
        // Get the original voice index from the selected option's data attribute
        const selectedOption = voiceSelect.options[voiceSelect.selectedIndex];
        
        if (voiceSelect.selectedIndex > 0) { // Not "Choose voice" option
          const originalVoiceIndex = parseInt(selectedOption.dataset.originalIndex);
          const voices = window.speechSynthesis.getVoices();
          const selectedVoice = voices[originalVoiceIndex];
          
          if (selectedVoice) {
            // Save the original voice index and name (correct method)
            localStorage.setItem('selectedVoiceIndex', originalVoiceIndex);
            localStorage.setItem('selectedVoiceName', selectedVoice.name);
            
            // Update global variables
            window.selectedVoice = selectedVoice;
          }
        } else {
          // "Choose voice" selected - clear selection
          localStorage.removeItem('selectedVoiceIndex');
          localStorage.removeItem('selectedVoiceName');
          window.selectedVoice = null;
        }
        
        // Save speech rate
        localStorage.setItem('speechRate', speechRateSelect.value);
        if (window.speechRate !== undefined) {
          window.speechRate = parseFloat(speechRateSelect.value);
        }
        
        console.log('Auto-saved voice settings (silent):', {
          voiceIndex: voiceSelect.selectedIndex,
          originalIndex: selectedOption.dataset.originalIndex,
          voiceName: voiceSelect.value,
          speechRate: speechRateSelect.value
        });
      }
    }

    // Voice settings functionality
    function saveVoiceSettings() {
      const voiceSelect = document.getElementById('voiceSelect');
      const speechRateSelect = document.getElementById('speechRateSelect');
      const statusDiv = document.getElementById('saveStatus');
      
      // Get the original voice index from the selected option's data attribute
      const selectedOption = voiceSelect.options[voiceSelect.selectedIndex];
      let originalVoiceIndex = null;
      let selectedVoice = null;
      
      if (voiceSelect.selectedIndex > 0) { // Not "Choose voice" option
        originalVoiceIndex = parseInt(selectedOption.dataset.originalIndex);
        const voices = window.speechSynthesis.getVoices();
        selectedVoice = voices[originalVoiceIndex];
        
        // Save the original voice index and name
        localStorage.setItem('selectedVoiceIndex', originalVoiceIndex);
        localStorage.setItem('selectedVoiceName', selectedVoice.name);
        
        // Update global variables
        window.selectedVoice = selectedVoice;
      } else {
        // "Choose voice" selected - clear selection
        localStorage.removeItem('selectedVoiceIndex');
        localStorage.removeItem('selectedVoiceName');
        window.selectedVoice = null;
      }
      
      // Save speech rate
      localStorage.setItem('speechRate', speechRateSelect.value);
      if (window.speechRate !== undefined) {
        window.speechRate = parseFloat(speechRateSelect.value);
      }
      
      // Voice confirmation using the correct voice (only speak once)
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                    (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      
      if (selectedVoice) {
        // Clear any pending speech to prevent conflicts
        window.speechSynthesis.cancel();
        
        const confirmationText = `Voice settings saved. You have selected ${selectedVoice.name.split(' ')[0]}`;
        const utterance = new SpeechSynthesisUtterance(confirmationText);
        utterance.voice = selectedVoice;
        utterance.rate = parseFloat(speechRateSelect.value);
        utterance.lang = "en-US"; // Force English
        
        // Small delay to ensure speech synthesis is ready
        setTimeout(() => {
          window.speechSynthesis.speak(utterance);
        }, 100);
        
        console.log(`ðŸ”Š Voice confirmation: "${confirmationText}" using voice: ${selectedVoice.name} (${selectedVoice.lang})`);
      }
      
      // Show success message
      statusDiv.textContent = "Voice settings saved successfully!";
      statusDiv.className = "status-message success";
      statusDiv.style.display = "block";
      
      // Hide message after 3 seconds
      setTimeout(() => {
        statusDiv.style.display = "none";
      }, 3000);
    }

    // Load saved settings when page loads
    function loadVoiceSettings() {
      const savedVoiceIndex = localStorage.getItem('selectedVoiceIndex');
      const savedSpeechRate = localStorage.getItem('speechRate');
      
      if (savedSpeechRate) {
        document.getElementById('speechRateSelect').value = savedSpeechRate;
      }
      
      // Wait for voices to load, then set saved voice
      if (savedVoiceIndex) {
        const checkVoices = () => {
          const voices = speechSynthesis.getVoices();
          if (voices.length > 0) {
            const voiceSelect = document.getElementById('voiceSelect');
            if (savedVoiceIndex < voices.length) {
              voiceSelect.selectedIndex = savedVoiceIndex;
            }
          } else {
            setTimeout(checkVoices, 100);
          }
        };
        checkVoices();
      }
    }

    // Check notification status
    function checkNotificationStatus() {
      const statusSpan = document.getElementById('notificationStatus');
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                    (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
      
      if (isIOS) {
        // For iOS Safari with OneSignal
        if (isSafari && window.OneSignal) {
          window.OneSignal.push(function() {
            window.OneSignal.isPushNotificationsEnabled(function(isEnabled) {
              if (isEnabled) {
                statusSpan.textContent = "iOS notifications active (OneSignal)";
                statusSpan.style.color = "#059669";
              } else {
                statusSpan.textContent = "iOS notifications not enabled - check the box below";
                statusSpan.style.color = "#f59e0b";
              }
            });
          });
        } 
        // For iOS with native Web Notifications (iOS 16.4+ on Firefox/Chrome)
        else if ('Notification' in window) {
          if (Notification.permission === 'granted') {
            statusSpan.textContent = "iOS notifications active (Native Web Push)";
            statusSpan.style.color = "#059669";
          } else if (Notification.permission === 'denied') {
            statusSpan.textContent = "iOS notifications blocked - check iOS Settings";
            statusSpan.style.color = "#dc2626";
          } else {
            statusSpan.textContent = "iOS notifications available - check the box below";
            statusSpan.style.color = "#f59e0b";
          }
        } 
        // No notification support detected
        else {
          statusSpan.textContent = "iOS notifications not available on this browser";
          statusSpan.style.color = "#6b7280";
        }
      } else {
        // Desktop notifications
        if ('Notification' in window) {
          if (Notification.permission === 'granted') {
            statusSpan.textContent = "Desktop notifications enabled";
            statusSpan.style.color = "#059669";
          } else if (Notification.permission === 'denied') {
            statusSpan.textContent = "Desktop notifications blocked - check browser settings";
            statusSpan.style.color = "#dc2626";
          } else {
            statusSpan.textContent = "Desktop notifications not configured - check the box below";
            statusSpan.style.color = "#f59e0b";
          }
        } else {
          statusSpan.textContent = "Notifications not supported in this browser";
          statusSpan.style.color = "#6b7280";
        }
      }
    }

    // Load voices into dropdown
    function loadVoices() {
      const voiceSelect = document.getElementById("voiceSelect");
      
      if (!voiceSelect) {
        console.log('voiceSelect element not found');
        return;
      }
      
      voiceSelect.innerHTML = "";
      
      const voices = speechSynthesis.getVoices();
      console.log('Available voices:', voices.length);
      
      if (voices.length === 0) {
        // Retry loading voices after a short delay
        console.log('No voices found, retrying...');
        setTimeout(loadVoices, 100);
        return;
      }
      
      console.log('Loading', voices.length, 'voices into dropdown');
      
      // Detect iOS for voice filtering
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                    (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      
      let filteredVoices;
      
      if (isIOS) {
        // For iOS, only show iOS-specific voices
        filteredVoices = voices.filter(v => 
          v.name.includes('Siri') || 
          v.localService === true ||
          v.name.includes('Alex') ||
          v.name.includes('Victoria') ||
          v.name.includes('Daniel') ||
          v.name.includes('Karen') ||
          v.name.includes('Moira') ||
          v.name.includes('Tessa') ||
          v.name.includes('Samantha') ||
          v.name.includes('Aaron') ||
          v.name.includes('Fred') ||
          v.name.includes('Nicky') ||
          v.name.includes('Vicki') ||
          v.name.includes('Princess') ||
          v.name.includes('Junior') ||
          v.name.includes('Ralph') ||
          v.name.includes('Albert') ||
          v.name.includes('Kathy') ||
          v.name.includes('Cellos') ||
          v.name.includes('Zarvox')
        );
        console.log(`iOS detected: Filtered to ${filteredVoices.length} iOS voices`);
      } else {
        // For non-iOS, filter for English voices or all voices if no English found
        filteredVoices = voices.filter(v => v.lang.startsWith("en"));
        if (filteredVoices.length === 0) {
          filteredVoices = voices; // Use all voices if no English ones
        }
        console.log(`Desktop detected: Using ${filteredVoices.length} English voices`);
      }
      
      // Sort voices by name for better organization
      filteredVoices.sort((a, b) => a.name.localeCompare(b.name));
      
      // Add default "Choose voice" option
      const defaultOption = document.createElement("option");
      defaultOption.value = "";
      defaultOption.textContent = "Choose voice...";
      voiceSelect.appendChild(defaultOption);
      
      filteredVoices.forEach(voice => {
        const option = document.createElement("option");
        option.value = voice.name;
        option.textContent = `${voice.name} (${voice.lang})`;
        // Store the original voice index from the full voices array
        option.dataset.originalIndex = voices.indexOf(voice);
        voiceSelect.appendChild(option);
      });

      // Set default to "Choose voice" (will be overridden by saved preferences)
      voiceSelect.selectedIndex = 0;
      console.log('Set default to "Choose voice" option');

      // Load saved voice preferences after voices are populated
      loadSavedVoicePreferences();
      
      console.log('âœ… Voice loading complete');
    }
    
    // Load saved voice preferences
    function loadSavedVoicePreferences() {
      // Load saved speech rate
      const savedRate = localStorage.getItem("speechRate");
      if (savedRate) {
        window.speechRate = parseFloat(savedRate);
        const speechRateSelect = document.getElementById("speechRateSelect");
        if (speechRateSelect) {
          speechRateSelect.value = savedRate;
          console.log('âœ… Restored speech rate:', savedRate);
        }
      }
      
      // Load saved voice index (preferred method)
      const savedVoiceIndex = localStorage.getItem("selectedVoiceIndex");
      const voices = window.speechSynthesis.getVoices();
      
      if (savedVoiceIndex && savedVoiceIndex !== "null" && voices.length > 0) {
        const index = parseInt(savedVoiceIndex);
        const voiceSelect = document.getElementById("voiceSelect");
        
        if (voiceSelect && index < voices.length) {
          // Find the option with the matching originalIndex
          const options = voiceSelect.options;
          for (let i = 1; i < options.length; i++) { // Start from 1 to skip "Choose voice"
            if (parseInt(options[i].dataset.originalIndex) === index) {
              voiceSelect.selectedIndex = i;
              window.selectedVoice = voices[index];
              
              console.log('âœ… Restored voice by index:', {
                originalIndex: index,
                dropdownIndex: i,
                name: voices[index].name,
                lang: voices[index].lang,
                voiceObject: voices[index]
              });
              return; // Successfully loaded
            }
          }
        }
      }
      
      // Fallback: try to find voice by name
      const savedVoiceName = localStorage.getItem("selectedVoiceName");
      if (savedVoiceName && voices.length > 0) {
        const voiceSelect = document.getElementById("voiceSelect");
        if (voiceSelect) {
          // Find the voice by name in the dropdown options
          const options = voiceSelect.options;
          for (let i = 1; i < options.length; i++) { // Start from 1 to skip "Choose voice"
            if (options[i].value === savedVoiceName) {
              const originalIndex = parseInt(options[i].dataset.originalIndex);
              voiceSelect.selectedIndex = i;
              window.selectedVoice = voices[originalIndex];
              
              console.log('âœ… Restored voice by name:', {
                name: savedVoiceName,
                originalIndex: originalIndex,
                dropdownIndex: i,
                voiceObject: voices[originalIndex]
              });
              return;
            }
          }
        }
      }
      
      // No saved voice found - leave on "Choose voice" option
      const voiceSelect = document.getElementById("voiceSelect");
      if (voiceSelect) {
        voiceSelect.selectedIndex = 0; // "Choose voice" option
        window.selectedVoice = null; // No voice selected
        console.log('âœ… No saved voice - defaulting to "Choose voice" option');
      }
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
      if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = loadVoices;
      }
      loadVoices();
      
      loadVoiceSettings();
      
      // Check notification status with proper OneSignal initialization wait
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                    (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
      
      // For iOS Safari with OneSignal, wait for it to be ready
      if (isIOS && isSafari && typeof window.OneSignal !== 'undefined') {
        window.OneSignal.push(function() {
          // OneSignal is now ready
          checkNotificationStatus();
          setupNotificationCheckbox();
        });
      } else {
        // For non-OneSignal platforms, check immediately with small delay for DOM
        setTimeout(function() {
          checkNotificationStatus();
          setupNotificationCheckbox();
        }, 100);
      }
      
      displayUserId();
    });
    
    // Display user ID function
    function displayUserId() {
      // Get user ID (same logic as in todo.js and list.html)
      function getUserId() {
        let userId = localStorage.getItem('taskmaster_user_id');
        if (!userId) {
          userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          localStorage.setItem('taskmaster_user_id', userId);
        }
        return userId;
      }
      
      const userIdElement = document.getElementById('currentUserId');
      if (userIdElement) {
        userIdElement.textContent = getUserId();
      }
    }
    
    // Handle notification checkbox
    function setupNotificationCheckbox() {
      const checkbox = document.getElementById('enableNotifications');
      const statusSpan = document.getElementById('notificationStatus');
      
      if (!checkbox) return;
      
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                    (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
      
      // Set initial checkbox state based on current notification permission
      if (isIOS && isSafari && window.OneSignal) {
        window.OneSignal.push(function() {
          window.OneSignal.isPushNotificationsEnabled(function(isEnabled) {
            checkbox.checked = isEnabled;
          });
        });
      } else if ('Notification' in window) {
        checkbox.checked = Notification.permission === 'granted';
      } else {
        checkbox.checked = false;
      }
      
      // Handle checkbox change event
      checkbox.addEventListener('change', function() {
        if (this.checked) {
          triggerNotificationPrompt();
        } else {
          statusSpan.textContent = "Notifications disabled";
          statusSpan.style.color = "#6b7280";
        }
      });
    }
    
    function triggerNotificationPrompt() {
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                    (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
      const statusSpan = document.getElementById('notificationStatus');
      const checkbox = document.getElementById('enableNotifications');
      
      // iOS Safari with OneSignal
      if (isIOS && isSafari && window.OneSignal) {
        statusSpan.textContent = "Requesting iOS notification permission...";
        statusSpan.style.color = "#3b82f6";
        
        window.OneSignal.push(function() {
          // Try to show native prompt first
          window.OneSignal.showNativePrompt().then(function() {
            // Wait for user response
            setTimeout(() => {
              window.OneSignal.isPushNotificationsEnabled(function(isEnabled) {
                if (isEnabled) {
                  statusSpan.textContent = "iOS notifications enabled (OneSignal)";
                  statusSpan.style.color = "#059669";
                  checkbox.checked = true;
                } else {
                  statusSpan.textContent = "iOS notifications not enabled - permission denied";
                  statusSpan.style.color = "#dc2626";
                  checkbox.checked = false;
                }
              });
            }, 1000);
          }).catch(function(error) {
            console.log('showNativePrompt failed, trying registerForPushNotifications:', error);
            
            // Fallback to registerForPushNotifications
            window.OneSignal.registerForPushNotifications().then(function() {
              setTimeout(() => {
                window.OneSignal.isPushNotificationsEnabled(function(isEnabled) {
                  if (isEnabled) {
                    statusSpan.textContent = "iOS notifications enabled (OneSignal)";
                    statusSpan.style.color = "#059669";
                    checkbox.checked = true;
                  } else {
                    statusSpan.textContent = "iOS notifications not enabled - permission needed";
                    statusSpan.style.color = "#f59e0b";
                    checkbox.checked = false;
                  }
                });
              }, 1000);
            }).catch(function(error) {
              console.error('OneSignal registration failed:', error);
              statusSpan.textContent = "iOS notifications setup failed - check HTTPS and settings";
              statusSpan.style.color = "#dc2626";
              checkbox.checked = false;
            });
          });
        });
      } 
      // iOS with native notifications (non-Safari browsers)
      else if (isIOS && 'Notification' in window) {
        tryIOSNativeNotifications();
      } 
      // Desktop notifications
      else {
        if ('Notification' in window) {
          if (Notification.permission === 'default') {
            statusSpan.textContent = "Requesting notification permission...";
            statusSpan.style.color = "#3b82f6";
            
            Notification.requestPermission().then(function(permission) {
              if (permission === 'granted') {
                statusSpan.textContent = "Desktop notifications enabled";
                statusSpan.style.color = "#059669";
                checkbox.checked = true;
                
                // Show welcome notification
                setTimeout(() => {
                  new Notification('TaskMaster Pro', {
                    body: 'Notifications enabled! You\'ll get reminders when tasks are due.',
                    icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHZpZXdCb3g9IjAgMCA0OCA0OCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHJ4PSIxMiIgZmlsbD0iIzRmNDZlNSIvPgogIDxwYXRoIGQ9Ik0xOCAyNGw0IDRsOC04IiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjMiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8L3N2Zz4K'
                  });
                }, 500);
              } else {
                statusSpan.textContent = "Desktop notifications denied";
                statusSpan.style.color = "#dc2626";
                checkbox.checked = false;
              }
            });
          } else if (Notification.permission === 'granted') {
            statusSpan.textContent = "Desktop notifications already enabled";
            statusSpan.style.color = "#059669";
            checkbox.checked = true;
          } else {
            statusSpan.textContent = "Desktop notifications blocked - check browser settings";
            statusSpan.style.color = "#dc2626";
            checkbox.checked = false;
          }
        } else {
          statusSpan.textContent = "Notifications not supported in this browser";
          statusSpan.style.color = "#6b7280";
          checkbox.checked = false;
        }
      }
    }
    
    // iOS Native Notification Fallback Function
    function tryIOSNativeNotifications() {
      const statusSpan = document.getElementById('notificationStatus');
      const checkbox = document.getElementById('enableNotifications');
      
      console.log('ðŸŽ Attempting iOS native notifications fallback...');
      
      // Check if iOS native notifications are available
      if (window.iosNativeNotificationsAvailable && 'Notification' in window) {
        if (Notification.permission === 'default') {
          console.log('ðŸ“± Requesting iOS native notification permission...');
          Notification.requestPermission().then(function(permission) {
            console.log('ðŸ“± iOS native permission result:', permission);
            if (permission === 'granted') {
              statusSpan.textContent = "iOS notifications enabled (Native Web Push)";
              checkbox.checked = true;
              window.iosNativeEnabled = true;
              
              // Show test notification
              setTimeout(() => {
                new Notification('TaskMaster Pro - iOS Native', {
                  body: 'Native iOS notifications enabled! You\'ll get reminders when tasks are due.',
                  icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHZpZXdCb3g9IjAgMCA0OCA0OCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHJ4PSIxMiIgZmlsbD0iIzRmNDZlNSIvPgogIDxwYXRoIGQ9Ik0xOCAyNGw0IDRsOC04IiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjMiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8L3N2Zz4K'
                });
              }, 500);
            } else {
              statusSpan.textContent = "iOS native notifications denied";
              checkbox.checked = false;
            }
          });
        } else if (Notification.permission === 'granted') {
          statusSpan.textContent = "iOS notifications already enabled (Native)";
          checkbox.checked = true;
          window.iosNativeEnabled = true;
        } else {
          statusSpan.textContent = "iOS notifications denied - check Safari settings";
          checkbox.checked = false;
        }
      } else {
        statusSpan.textContent = "iOS native notifications not supported (requires iOS 16.4+)";
        checkbox.checked = false;
      }
    }
  </script>
  
  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyC1S6U4E_IIAw5csnapl8ZoIyBS_Lv5k2A",
      authDomain: "taskmaster-pro-bf98a.firebaseapp.com",
      projectId: "taskmaster-pro-bf98a",
      storageBucket: "taskmaster-pro-bf98a.firebasestorage.app",
      messagingSenderId: "47778628154",
      appId: "1:47778628154:web:eddd6a64147d917fcb6b03",
      measurementId: "G-JERNL4E72Z"
    };

    // Initialize Firebase
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Set auth persistence to LOCAL
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch((error) => {
      console.error('Error setting auth persistence:', error);
    });

    // Check authentication state
    auth.onAuthStateChanged((user) => {
      const welcomeMsg = document.getElementById('welcome-message');
      const guestNotice = document.getElementById('guest-notice');
      const usernameEl = document.getElementById('username');
      
      if (user) {
        const displayName = user.displayName || user.email.split('@')[0];
        usernameEl.textContent = displayName;
        welcomeMsg.style.display = 'block';
        guestNotice.style.display = 'none';
        window.currentUser = user;
        window.isGuestMode = false;
        
        // Set user presence to online
        setUserPresence(user, true);
      } else {
        welcomeMsg.style.display = 'none';
        guestNotice.style.display = 'block';
        window.currentUser = null;
        window.isGuestMode = true;
      }
    });

    // Sign out function
    async function signOut() {
      const user = auth.currentUser;
      if (user) {
        // Wait for presence to be updated before signing out
        await setUserPresence(user, false);
      }
      
      auth.signOut().then(() => {
        alert('Signed out successfully!');
        window.location.href = 'index.html';
      });
    }
    
    // Set user online/offline presence
    function setUserPresence(user, online) {
      if (!user) return Promise.resolve();
      
      return db.collection('presence').doc(user.uid).set({
        online: online,
        username: user.displayName || user.email.split('@')[0],
        email: user.email,
        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true }).catch(error => console.error('Error updating presence:', error));
    }
    
    // Heartbeat: Update lastSeen every 30 seconds
    let heartbeatInterval;
    
    auth.onAuthStateChanged((user) => {
      // Clear any existing heartbeat
      if (heartbeatInterval) clearInterval(heartbeatInterval);
      
      if (user) {
        // Update presence immediately
        setUserPresence(user, true);
        
        // Set up heartbeat to update lastSeen every 30 seconds
        heartbeatInterval = setInterval(() => {
          db.collection('presence').doc(user.uid).update({
            lastSeen: firebase.firestore.FieldValue.serverTimestamp()
          }).catch(error => console.error('Heartbeat error:', error));
        }, 30000);
      }
    });
    
    // Mark user offline when closing tab/browser (best effort)
    window.addEventListener('beforeunload', () => {
      const user = auth.currentUser;
      if (user) {
        // Use synchronous update attempt
        navigator.sendBeacon && db.collection('presence').doc(user.uid).update({
          online: false,
          lastSeen: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
    });

    // Delete account function
    async function deleteAccount() {
      const user = auth.currentUser;
      
      if (!user) {
        alert('You must be logged in to delete your account.');
        return;
      }
      
      const confirmation = prompt('This will permanently delete your account and all data. Type "DELETE" in all caps to confirm:');
      
      if (!confirmation || confirmation.trim().toUpperCase() !== 'DELETE') {
        alert('Account deletion cancelled.');
        return;
      }
      
      try {
        const userId = user.uid;
        
        // Delete all user data from Firestore
        console.log('Deleting user data from Firestore...');
        
        // Delete presence data
        await db.collection('presence').doc(userId).delete();
        
        // Delete tasks
        await db.collection('users').doc(userId).collection('tasks').doc('data').delete();
        
        // Delete lists
        await db.collection('users').doc(userId).collection('lists').doc('data').delete();
        
        // Delete user document
        await db.collection('users').doc(userId).delete();
        
        console.log('Firestore data deleted successfully');
        
        // Delete authentication account
        await user.delete();
        
        alert('Your account and all data have been permanently deleted.');
        window.location.href = 'index.html';
        
      } catch (error) {
        console.error('Error deleting account:', error);
        
        if (error.code === 'auth/requires-recent-login') {
          alert('For security reasons, you need to sign in again before deleting your account. Please sign out and sign back in, then try again.');
        } else {
          alert('Error deleting account: ' + error.message);
        }
      }
    }
  </script>

</body>
</html>