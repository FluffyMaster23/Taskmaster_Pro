<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Options - TaskMaster Pro</title>
  
  <!-- PWA Meta Tags -->
  <meta name="description" content="TaskMaster Pro - Master your tasks, dominate your day with advanced reminders and notifications" />
  <meta name="theme-color" content="#4f46e5" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="TaskMaster Pro" />
  <meta name="msapplication-TileColor" content="#4f46e5" />
  <meta name="msapplication-config" content="browserconfig.xml" />
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="./manifest.json" />
  
  <!-- OneSignal for iOS notifications -->
  <script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async=""></script>
  
  <!-- Favicon and App Icons -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHZpZXdCb3g9IjAgMCA0OCA0OCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHJ4PSIxMiIgZmlsbD0iIzRmNDZlNSIvPgogIDxwYXRoIGQ9Ik0xOCAyNGw0IDRsOC04IiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjMiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8L3N2Zz4K" />
  <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiAgPHJlY3Qgd2lkdGg9IjE5MiIgaGVpZ2h0PSIxOTIiIHJ4PSI0OCIgZmlsbD0iIzRmNDZlNSIvPgogIDxwYXRoIGQ9Ik03MiA5NmwxNiAxNmwzMi0zMiIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIxMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+Cjwvc3ZnPgo=" />
  
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f5f5f5; }
    
    /* Navigation Bar */
    .navbar {
      background: #4f46e5;
      padding: 15px 0;
      margin: -20px -20px 20px -20px;
      text-align: center;
    }
    .navbar a {
      color: white;
      text-decoration: none;
      margin: 0 20px;
      padding: 8px 16px;
      border-radius: 4px;
      transition: background 0.3s;
    }
    .navbar a:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    .navbar a.active {
      background: rgba(255, 255, 255, 0.3);
      font-weight: bold;
    }
    
    /* Options styling */
    .options-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .options-section h2 {
      margin-top: 0;
      color: #4f46e5;
      border-bottom: 2px solid #e5e7eb;
      padding-bottom: 10px;
    }
    label {
      display: block;
      font-weight: bold;
      margin: 15px 0 5px 0;
      color: #374151;
    }
    select {
      display: block;
      margin: 5px 0 15px 0;
      padding: 8px;
      width: 100%;
      max-width: 400px;
      border: 2px solid #d1d5db;
      border-radius: 4px;
      font-size: 14px;
    }
    select:focus {
      outline: none;
      border-color: #4f46e5;
    }
    .save-btn {
      background: #10b981;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 15px;
    }
    .save-btn:hover {
      background: #059669;
    }
    .status-message {
      margin-top: 10px;
      padding: 8px;
      border-radius: 4px;
      display: none;
    }
    .status-message.success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #a7f3d0;
    }
  </style>
</head>
<body>
  <!-- Navigation Bar -->
  <nav class="navbar">
    <a href="index.html">TaskMaster Home</a>
    <a href="taskmaster.html">Your Lists</a>
    <a href="options.html" class="active">Options</a>
  </nav>

  <h1>TaskMaster Pro Options</h1>
  
  <div class="options-section">
    <h2>Voice & Speech Settings</h2>
    
    <label for="voiceSelect">Choose Voice:</label>
    <select id="voiceSelect" aria-label="Choose voice" onchange="autoSaveVoiceSettings()">
      <option value="">Loading voices...</option>
    </select>

    <label for="speechRateSelect">Speech Speed:</label>
    <select id="speechRateSelect" aria-label="Choose speech speed" onchange="autoSaveVoiceSettings()">
      <option value="0.5">Very Slow (0.5x)</option>
      <option value="0.75">Slow (0.75x)</option>
      <option value="1" selected>Normal (1x)</option>
      <option value="1.25">Fast (1.25x)</option>
      <option value="1.5">Very Fast (1.5x)</option>
      <option value="1.75">Super Fast (1.75x)</option>
      <option value="2">Maximum (2x)</option>
    </select>

    <button class="save-btn" onclick="saveVoiceSettings()">Save Voice Settings</button>
    <div id="saveStatus" class="status-message"></div>
  </div>

  <div class="options-section">
    <h2>Notification Settings</h2>
    <p><strong>Status:</strong> <span id="notificationStatus">Checking...</span></p>
    
    <label for="enableNotifications" style="margin-top: 20px;">
      <input type="checkbox" id="enableNotifications" style="width: auto; margin-right: 10px;">
      Enable Push Notifications
    </label>
    <p style="font-size: 0.9em; color: #6b7280; margin-top: 5px;">Check this box to trigger the notification permission prompt and enable push notifications for task reminders.</p>
    
    <p style="margin-top: 15px;">Notifications are automatically configured based on your platform (iOS uses OneSignal, desktop uses native notifications).</p>
    <p style="font-size: 0.9em; color: #f59e0b; margin-top: 10px;"><strong>Note for iOS:</strong> Notifications require the app to be deployed on HTTPS. Local development (localhost) may not support OneSignal notifications on iOS devices.</p>
  </div>

  <div class="options-section">
    <h2>App Information</h2>
    <p><strong>Version:</strong> TaskMaster Pro v1.0</p>
    <p><strong>Platform:</strong> Progressive Web App (PWA)</p>
    <p><strong>Features:</strong> Cross-platform notifications, Voice feedback, Task reminders</p>
  </div>

  <script src="todo.js"></script>
  <script>
    // Auto-save voice settings when changed
    function autoSaveVoiceSettings() {
      const voiceSelect = document.getElementById('voiceSelect');
      const speechRateSelect = document.getElementById('speechRateSelect');
      
      if (voiceSelect && speechRateSelect) {
        // Save to localStorage using consistent method with todo.js
        localStorage.setItem('selectedVoiceIndex', voiceSelect.selectedIndex);
        localStorage.setItem('selectedVoiceName', voiceSelect.value);
        localStorage.setItem('speechRate', speechRateSelect.value);
        
        // Update global variables if they exist
        if (window.speechSynthesis && voiceSelect.selectedIndex >= 0) {
          const voices = window.speechSynthesis.getVoices();
          if (voices.length > voiceSelect.selectedIndex) {
            window.selectedVoice = voices[voiceSelect.selectedIndex];
          }
        }
        if (window.speechRate !== undefined) {
          window.speechRate = parseFloat(speechRateSelect.value);
        }
        
        console.log('Auto-saved voice settings:', {
          voiceIndex: voiceSelect.selectedIndex,
          voiceName: voiceSelect.value,
          speechRate: speechRateSelect.value
        });
      }
    }

    // Voice settings functionality
    function saveVoiceSettings() {
      const voiceSelect = document.getElementById('voiceSelect');
      const speechRateSelect = document.getElementById('speechRateSelect');
      const statusDiv = document.getElementById('saveStatus');
      
      // Save to localStorage
      localStorage.setItem('selectedVoiceIndex', voiceSelect.selectedIndex);
      localStorage.setItem('speechRate', speechRateSelect.value);
      
      // Update global variables if they exist
      if (window.selectedVoice && window.speechSynthesis) {
        window.selectedVoice = window.speechSynthesis.getVoices()[voiceSelect.selectedIndex];
      }
      if (window.speechRate !== undefined) {
        window.speechRate = parseFloat(speechRateSelect.value);
      }
      
      // Show success message
      statusDiv.textContent = "Voice settings saved successfully!";
      statusDiv.className = "status-message success";
      statusDiv.style.display = "block";
      
      // Hide message after 3 seconds
      setTimeout(() => {
        statusDiv.style.display = "none";
      }, 3000);
    }

    // Load saved settings when page loads
    function loadVoiceSettings() {
      const savedVoiceIndex = localStorage.getItem('selectedVoiceIndex');
      const savedSpeechRate = localStorage.getItem('speechRate');
      
      if (savedSpeechRate) {
        document.getElementById('speechRateSelect').value = savedSpeechRate;
      }
      
      // Wait for voices to load, then set saved voice
      if (savedVoiceIndex) {
        const checkVoices = () => {
          const voices = speechSynthesis.getVoices();
          if (voices.length > 0) {
            const voiceSelect = document.getElementById('voiceSelect');
            if (savedVoiceIndex < voices.length) {
              voiceSelect.selectedIndex = savedVoiceIndex;
            }
          } else {
            setTimeout(checkVoices, 100);
          }
        };
        checkVoices();
      }
    }

    // Check notification status
    function checkNotificationStatus() {
      const statusSpan = document.getElementById('notificationStatus');
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                    (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      
      if (isIOS) {
        if (window.oneSignalEnabled) {
          statusSpan.textContent = "iOS notifications active (OneSignal)";
        } else {
          statusSpan.textContent = "iOS notifications pending setup";
        }
      } else {
        if (Notification && Notification.permission === 'granted') {
          statusSpan.textContent = "Desktop notifications enabled";
        } else if (Notification && Notification.permission === 'denied') {
          statusSpan.textContent = "Desktop notifications blocked";
        } else {
          statusSpan.textContent = "Desktop notifications not configured";
        }
      }
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
      loadVoiceSettings();
      setTimeout(checkNotificationStatus, 1000); // Give time for OneSignal to load
      
      // Setup notification checkbox handler
      setupNotificationCheckbox();
    });
    
    // Handle notification checkbox
    function setupNotificationCheckbox() {
      const checkbox = document.getElementById('enableNotifications');
      const statusSpan = document.getElementById('notificationStatus');
      
      if (!checkbox) return;
      
      // Check initial state based on current permissions
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      
      if (isIOS) {
        // For iOS, check if OneSignal is enabled and subscribed
        if (window.OneSignal) {
          OneSignal.getSubscription().then(function(subscription) {
            checkbox.checked = !!subscription;
          });
        }
      } else {
        // For desktop, check native notification permission
        checkbox.checked = Notification && Notification.permission === 'granted';
      }
      
      // Handle checkbox change
      checkbox.addEventListener('change', function() {
        if (this.checked) {
          triggerNotificationPrompt();
        } else {
          // If unchecked, just update status (can't really disable notifications once granted)
          statusSpan.textContent = "Notifications disabled by user";
        }
      });
    }
    
    // Trigger notification permission prompt
    function triggerNotificationPrompt() {
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      const statusSpan = document.getElementById('notificationStatus');
      const checkbox = document.getElementById('enableNotifications');
      
      if (isIOS) {
        // For iOS, use OneSignal
        if (window.OneSignal) {
          console.log('Triggering OneSignal permission prompt...');
          
          // Check if we're on HTTPS or localhost
          const isSecure = window.location.protocol === 'https:' || 
                          window.location.hostname === 'localhost' || 
                          window.location.hostname === '127.0.0.1';
          
          if (!isSecure) {
            statusSpan.textContent = "Notifications require HTTPS on iOS";
            checkbox.checked = false;
            return;
          }
          
          // Force OneSignal to show permission prompt
          OneSignal.showSlidedownPrompt().then(function() {
            console.log('OneSignal slidedown prompt shown');
          }).catch(function(error) {
            console.log('OneSignal slidedown prompt error:', error);
            
            // Fallback: try direct notification prompt
            OneSignal.showNativePrompt().then(function() {
              console.log('OneSignal native prompt shown');
            }).catch(function(nativeError) {
              console.log('OneSignal native prompt error:', nativeError);
              statusSpan.textContent = "OneSignal setup failed - try refreshing page";
              checkbox.checked = false;
            });
          });
          
          // Check subscription status after prompt
          setTimeout(() => {
            OneSignal.getSubscription().then(function(subscription) {
              if (subscription) {
                statusSpan.textContent = "iOS notifications enabled (OneSignal)";
                checkbox.checked = true;
              } else {
                statusSpan.textContent = "iOS notifications denied or cancelled";
                checkbox.checked = false;
              }
            });
          }, 2000);
          
        } else {
          statusSpan.textContent = "OneSignal not loaded - please refresh page";
          checkbox.checked = false;
        }
      } else {
        // For desktop, use native notifications
        if (Notification) {
          Notification.requestPermission().then(function(permission) {
            if (permission === 'granted') {
              statusSpan.textContent = "Desktop notifications enabled";
              checkbox.checked = true;
            } else {
              statusSpan.textContent = "Desktop notifications denied";
              checkbox.checked = false;
            }
          });
        } else {
          statusSpan.textContent = "Notifications not supported in this browser";
          checkbox.checked = false;
        }
      }
    }
  </script>

</body>
</html>