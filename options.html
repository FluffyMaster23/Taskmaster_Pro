<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Options - TaskMaster Pro</title>
  
  <!-- PWA Meta Tags -->
  <meta name="description" content="TaskMaster Pro - Master your tasks, dominate your day with advanced reminders and notifications" />
  <meta name="theme-color" content="#4f46e5" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="TaskMaster Pro" />
  <meta name="msapplication-TileColor" content="#4f46e5" />
  <meta name="msapplication-config" content="browserconfig.xml" />
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="./manifest.json" />
  
  <!-- OneSignal for iOS notifications -->
  <script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async=""></script>
  
  <!-- Favicon and App Icons -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHZpZXdCb3g9IjAgMCA0OCA0OCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHJ4PSIxMiIgZmlsbD0iIzRmNDZlNSIvPgogIDxwYXRoIGQ9Ik0xOCAyNGw0IDRsOC04IiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjMiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8L3N2Zz4K" />
  <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiAgPHJlY3Qgd2lkdGg9IjE5MiIgaGVpZ2h0PSIxOTIiIHJ4PSI0OCIgZmlsbD0iIzRmNDZlNSIvPgogIDxwYXRoIGQ9Ik03MiA5NmwxNiAxNmwzMi0zMiIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIxMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+Cjwvc3ZnPgo=" />
  
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f5f5f5; }
    
    /* Navigation Bar */
    .navbar {
      background: #4f46e5;
      padding: 15px 0;
      margin: -20px -20px 20px -20px;
      text-align: center;
    }
    .navbar a {
      color: white;
      text-decoration: none;
      margin: 0 20px;
      padding: 8px 16px;
      border-radius: 4px;
      transition: background 0.3s;
    }
    .navbar a:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    .navbar a.active {
      background: rgba(255, 255, 255, 0.3);
      font-weight: bold;
    }
    
    /* Options styling */
    .options-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .options-section h2 {
      margin-top: 0;
      color: #4f46e5;
      border-bottom: 2px solid #e5e7eb;
      padding-bottom: 10px;
    }
    label {
      display: block;
      font-weight: bold;
      margin: 15px 0 5px 0;
      color: #374151;
    }
    select {
      display: block;
      margin: 5px 0 15px 0;
      padding: 8px;
      width: 100%;
      max-width: 400px;
      border: 2px solid #d1d5db;
      border-radius: 4px;
      font-size: 14px;
    }
    select:focus {
      outline: none;
      border-color: #4f46e5;
    }
    .save-btn {
      background: #10b981;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 15px;
    }
    .save-btn:hover {
      background: #059669;
    }
    .status-message {
      margin-top: 10px;
      padding: 8px;
      border-radius: 4px;
      display: none;
    }
    .status-message.success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #a7f3d0;
    }
  </style>
</head>
<body>
  <!-- Navigation Bar -->
  <nav class="navbar">
    <a href="index.html">TaskMaster Home</a>
    <a href="taskmaster.html">Your Lists</a>
    <a href="options.html" class="active">Options</a>
  </nav>

  <h1>TaskMaster Pro Options</h1>
  
  <div class="options-section">
    <h2>Voice & Speech Settings</h2>
    
    <label for="voiceSelect">Choose Voice:</label>
    <select id="voiceSelect" aria-label="Choose voice" onchange="autoSaveVoiceSettings()">
      <option value="">Loading voices...</option>
    </select>

    <label for="speechRateSelect">Speech Speed:</label>
    <select id="speechRateSelect" aria-label="Choose speech speed" onchange="autoSaveVoiceSettings()">
      <option value="0.5">Very Slow (0.5x)</option>
      <option value="0.75">Slow (0.75x)</option>
      <option value="1" selected>Normal (1x)</option>
      <option value="1.25">Fast (1.25x)</option>
      <option value="1.5">Very Fast (1.5x)</option>
      <option value="1.75">Super Fast (1.75x)</option>
      <option value="2">Maximum (2x)</option>
    </select>

    <button class="save-btn" onclick="saveVoiceSettings()">Save Voice Settings</button>
    <div id="saveStatus" class="status-message"></div>
  </div>

  <div class="options-section">
    <h2>Notification Settings</h2>
    <p><strong>Status:</strong> <span id="notificationStatus">Checking...</span></p>
    
    <label for="enableNotifications" style="margin-top: 20px;">
      <input type="checkbox" id="enableNotifications" style="width: auto; margin-right: 10px;">
      Enable Push Notifications
    </label>
    <p style="font-size: 0.9em; color: #6b7280; margin-top: 5px;">Check this box to trigger the notification permission prompt and enable push notifications for task reminders.</p>
    
    <p style="margin-top: 15px;">Notifications are automatically configured based on your platform (iOS uses OneSignal, desktop uses native notifications).</p>
    <p style="font-size: 0.9em; color: #f59e0b; margin-top: 10px;"><strong>Note for iOS:</strong> Notifications require the app to be deployed on HTTPS. Local development (localhost) may not support OneSignal notifications on iOS devices.</p>
    
    <!-- Test Notification Button -->
    <button onclick="testNotification()" style="margin-top: 15px; background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
      Test Notification
    </button>
    <p style="font-size: 0.8em; color: #6b7280; margin-top: 5px;">Click to test if notifications are working on your device.</p>
    
    <!-- Debug Button for iOS -->
    <button onclick="debugNotifications()" style="margin-top: 10px; background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
      Debug Notifications
    </button>
    <p style="font-size: 0.8em; color: #6b7280; margin-top: 5px;">View detailed notification status and troubleshooting info.</p>
  </div>

  <div class="options-section">
    <h2>App Information</h2>
    <p><strong>Version:</strong> TaskMaster Pro v1.0</p>
    <p><strong>Platform:</strong> Progressive Web App (PWA)</p>
    <p><strong>Features:</strong> Cross-platform notifications, Voice feedback, Task reminders</p>
  </div>

  <script src="todo.js"></script>
  <script>
    // Enhanced test notification function for iOS debugging
    function testNotification() {
      console.log('üß™ Testing notification...');
      
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                    (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      const isFirefox = navigator.userAgent.includes('Firefox');
      const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
      const isHTTPS = location.protocol === 'https:';
      
      console.log('üîç Platform detection:', { 
        isIOS, isFirefox, isSafari, isHTTPS,
        userAgent: navigator.userAgent,
        protocol: location.protocol,
        hostname: location.hostname
      });
      
      if (isIOS) {
        console.log('üì± iOS detected - starting comprehensive notification test...');
        
        // Method 1: Try native Web Notifications first (iOS 16.4+ with Firefox/Chrome)
        if ('Notification' in window && !isSafari) {
          console.log('üåê Testing native Web Notifications on iOS...');
          console.log('üìä Current permission:', Notification.permission);
          
          if (Notification.permission === 'granted') {
            console.log('‚úÖ Native permission already granted, sending test notification...');
            try {
              const notification = new Notification('üß™ TaskMaster Pro Test', {
                body: 'Native iOS notification is working! ‚úÖ',
                icon: '/favicon.ico',
                badge: '/favicon.ico',
                tag: 'taskmaster-test',
                requireInteraction: false,
                silent: false,
                timestamp: Date.now()
              });
              
              notification.onclick = function() {
                console.log('üì± Notification clicked');
                window.focus();
                notification.close();
              };
              
              // Auto-close after 8 seconds
              setTimeout(() => {
                notification.close();
              }, 8000);
              
              alert('‚úÖ Native test notification sent! Check your notification center.');
              return;
            } catch (error) {
              console.error('‚ùå Native notification failed:', error);
              alert('‚ùå Native notification failed: ' + error.message);
            }
          } else if (Notification.permission === 'default') {
            console.log('üîî Requesting native notification permission...');
            Notification.requestPermission().then(function(permission) {
              console.log('üìã Permission result:', permission);
              if (permission === 'granted') {
                alert('‚úÖ Native notification permission granted! Click Test again.');
              } else {
                alert('‚ùå Native notification permission denied. Try enabling in iOS Settings.');
              }
            }).catch(function(error) {
              console.error('‚ùå Permission request failed:', error);
              alert('‚ùå Permission request failed: ' + error.message);
            });
            return;
          } else {
            console.log('‚ùå Native notifications denied');
            alert('‚ùå Native notifications denied. Please enable in iOS Settings ‚Üí Safari ‚Üí Notifications.');
          }
        }
        
        // Method 2: Try OneSignal for Safari or as fallback
        if (window.OneSignal && (isSafari || Notification.permission !== 'granted')) {
          console.log('üî• Testing OneSignal on iOS...');
          
          // Wait for OneSignal to be ready
          window.OneSignal.push(function() {
            console.log('üì° OneSignal is ready, checking status...');
            
            // Get detailed OneSignal status
            window.OneSignal.isPushNotificationsEnabled(function(isEnabled) {
              console.log('üìä OneSignal enabled:', isEnabled);
              
              if (isEnabled) {
                console.log('‚úÖ OneSignal is enabled, sending test notification...');
                
                window.OneSignal.sendSelfNotification(
                  "üß™ TaskMaster Pro Test",
                  "OneSignal iOS notification is working! ‚úÖ",
                  window.location.href,
                  "/favicon.ico"
                ).then(function() {
                  console.log('‚úÖ OneSignal test notification sent successfully');
                  alert('‚úÖ OneSignal test notification sent! Check your notification center.');
                }).catch(function(error) {
                  console.error('‚ùå OneSignal test failed:', error);
                  alert('‚ùå OneSignal test failed: ' + error.message + '\n\nTry: iOS Settings ‚Üí Notifications ‚Üí Allow notifications for this site');
                });
              } else {
                console.log('‚ö†Ô∏è OneSignal not enabled, attempting to subscribe...');
                
                // Try to register for push notifications
                window.OneSignal.registerForPushNotifications().then(function() {
                  console.log('‚úÖ OneSignal registration successful');
                  alert('‚úÖ OneSignal registration successful! Please try the test again.');
                }).catch(function(error) {
                  console.error('‚ùå OneSignal registration failed:', error);
                  
                  // Show detailed troubleshooting
                  const troubleshooting = `‚ùå OneSignal registration failed: ${error.message}

üîß Troubleshooting steps:
1. Make sure you're using Safari on iOS
2. Enable notifications: iOS Settings ‚Üí Safari ‚Üí Notifications
3. Allow notifications when prompted
4. Make sure the website is loaded over HTTPS
5. Try refreshing the page and testing again

Current status: ${isHTTPS ? 'HTTPS ‚úÖ' : 'HTTP ‚ùå'}
Browser: ${isSafari ? 'Safari ‚úÖ' : 'Not Safari ‚ùå'}`;
                  
                  alert(troubleshooting);
                });
              }
            });
            
            // Also check user ID for debugging
            window.OneSignal.getUserId(function(userId) {
              console.log('üë§ OneSignal User ID:', userId);
            });
            
            // Check subscription details
            window.OneSignal.getSubscription(function(subscription) {
              console.log('üìß OneSignal Subscription:', subscription);
            });
          });
        } else if (!window.OneSignal) {
          console.log('‚ùå OneSignal not available');
          alert('‚ùå OneSignal not available. Make sure:\n1. You\'re on HTTPS\n2. The page has fully loaded\n3. OneSignal SDK is properly loaded');
        }
        
        // If nothing worked, show comprehensive help
        setTimeout(() => {
          if (!window.testNotificationSent) {
            const helpMessage = `üö® iOS Notification Troubleshooting:

üì± For iOS 16.4+ (Firefox/Chrome):
‚Ä¢ Enable: iOS Settings ‚Üí [Browser] ‚Üí Notifications
‚Ä¢ Website permissions: Allow notifications when prompted

üß≠ For iOS Safari:
‚Ä¢ Enable: iOS Settings ‚Üí Safari ‚Üí Notifications  
‚Ä¢ Website permissions: Allow notifications for this site

üîß General troubleshooting:
‚Ä¢ Ensure you're on HTTPS (https://)
‚Ä¢ Refresh the page completely
‚Ä¢ Try in private/incognito mode
‚Ä¢ Check iOS Settings ‚Üí Notifications ‚Üí [App/Browser]

Current: ${isHTTPS ? 'HTTPS ‚úÖ' : 'HTTP ‚ùå'} | ${isSafari ? 'Safari' : isFirefox ? 'Firefox' : 'Other'}`;
            
            console.log(helpMessage);
          }
        }, 2000);
        
      } else {
        // Desktop/non-iOS testing
        console.log('üíª Desktop detected - testing native notifications...');
        
        if ('Notification' in window) {
          if (Notification.permission === 'granted') {
            const notification = new Notification('üß™ TaskMaster Pro Test', {
              body: 'Desktop notification is working! ‚úÖ',
              icon: '/favicon.ico'
            });
            
            setTimeout(() => notification.close(), 5000);
            alert('‚úÖ Desktop test notification sent!');
          } else {
            Notification.requestPermission().then(function(permission) {
              if (permission === 'granted') {
                alert('‚úÖ Desktop notification permission granted! Try the test again.');
              } else {
                alert('‚ùå Desktop notification permission denied.');
              }
            });
          }
        } else {
          alert('‚ùå Notifications not supported in this browser.');
        }
      }
    }
    
    // Debug function to show detailed notification status
    function debugNotifications() {
      console.log('üîç Starting notification debug...');
      
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                    (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      const isFirefox = navigator.userAgent.includes('Firefox');
      const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
      const isHTTPS = location.protocol === 'https:';
      
      let debugInfo = `üîç NOTIFICATION DEBUG REPORT\n\n`;
      debugInfo += `üì± Platform: ${isIOS ? 'iOS' : 'Desktop'}\n`;
      debugInfo += `üåê Browser: ${isSafari ? 'Safari' : isFirefox ? 'Firefox' : 'Other'}\n`;
      debugInfo += `üîí Protocol: ${location.protocol} (${isHTTPS ? 'Secure ‚úÖ' : 'Not Secure ‚ùå'})\n`;
      debugInfo += `üè† Hostname: ${location.hostname}\n`;
      debugInfo += `üë§ User Agent: ${navigator.userAgent}\n\n`;
      
      // Check native notification support
      if ('Notification' in window) {
        debugInfo += `üîî Native Notifications: Supported ‚úÖ\n`;
        debugInfo += `üìä Permission: ${Notification.permission}\n`;
      } else {
        debugInfo += `üîî Native Notifications: Not Supported ‚ùå\n`;
      }
      
      // Check service worker support
      if ('serviceWorker' in navigator) {
        debugInfo += `‚öôÔ∏è Service Worker: Supported ‚úÖ\n`;
        navigator.serviceWorker.getRegistrations().then(registrations => {
          console.log('Service Worker Registrations:', registrations);
        });
      } else {
        debugInfo += `‚öôÔ∏è Service Worker: Not Supported ‚ùå\n`;
      }
      
      // Check OneSignal status
      if (window.OneSignal) {
        debugInfo += `üî• OneSignal: Available ‚úÖ\n`;
        
        window.OneSignal.push(function() {
          window.OneSignal.isPushNotificationsEnabled(function(isEnabled) {
            debugInfo += `üì° OneSignal Enabled: ${isEnabled ? 'Yes ‚úÖ' : 'No ‚ùå'}\n`;
            
            window.OneSignal.getUserId(function(userId) {
              debugInfo += `üë§ OneSignal User ID: ${userId || 'None'}\n`;
              
              window.OneSignal.getSubscription(function(subscription) {
                debugInfo += `üìß OneSignal Subscription: ${subscription ? 'Active' : 'None'}\n`;
                
                if (isIOS) {
                  debugInfo += `\nüçé iOS TROUBLESHOOTING:\n`;
                  if (isSafari) {
                    debugInfo += `‚Ä¢ Using Safari ‚úÖ\n`;
                    debugInfo += `‚Ä¢ Enable: iOS Settings ‚Üí Safari ‚Üí Notifications\n`;
                    debugInfo += `‚Ä¢ Allow notifications when prompted\n`;
                    if (!isHTTPS) {
                      debugInfo += `‚Ä¢ ‚ö†Ô∏è HTTPS required for OneSignal on iOS\n`;
                    }
                  } else {
                    debugInfo += `‚Ä¢ Using ${isFirefox ? 'Firefox' : 'Other Browser'}\n`;
                    debugInfo += `‚Ä¢ iOS 16.4+ required for native notifications\n`;
                    debugInfo += `‚Ä¢ Enable: iOS Settings ‚Üí [Browser] ‚Üí Notifications\n`;
                  }
                } else {
                  debugInfo += `\nüíª DESKTOP TROUBLESHOOTING:\n`;
                  debugInfo += `‚Ä¢ Allow notifications when prompted\n`;
                  debugInfo += `‚Ä¢ Check browser notification settings\n`;
                  debugInfo += `‚Ä¢ Ensure site permissions allow notifications\n`;
                }
                
                debugInfo += `\nüìù Console logs show more details.`;
                
                // Show in alert and log to console
                alert(debugInfo);
                console.log(debugInfo);
              });
            });
          });
        });
      } else {
        debugInfo += `üî• OneSignal: Not Available ‚ùå\n`;
        debugInfo += `‚Ä¢ Check if HTTPS is enabled\n`;
        debugInfo += `‚Ä¢ Ensure OneSignal SDK loaded correctly\n`;
        
        alert(debugInfo);
        console.log(debugInfo);
      }
    }
    
    // Auto-save voice settings when changed (silent auto-save, no voice announcements)
    function autoSaveVoiceSettings() {
      const voiceSelect = document.getElementById('voiceSelect');
      const speechRateSelect = document.getElementById('speechRateSelect');
      
      if (voiceSelect && speechRateSelect) {
        // Get the original voice index from the selected option's data attribute
        const selectedOption = voiceSelect.options[voiceSelect.selectedIndex];
        
        if (voiceSelect.selectedIndex > 0) { // Not "Choose voice" option
          const originalVoiceIndex = parseInt(selectedOption.dataset.originalIndex);
          const voices = window.speechSynthesis.getVoices();
          const selectedVoice = voices[originalVoiceIndex];
          
          if (selectedVoice) {
            // Save the original voice index and name (correct method)
            localStorage.setItem('selectedVoiceIndex', originalVoiceIndex);
            localStorage.setItem('selectedVoiceName', selectedVoice.name);
            
            // Update global variables
            window.selectedVoice = selectedVoice;
          }
        } else {
          // "Choose voice" selected - clear selection
          localStorage.removeItem('selectedVoiceIndex');
          localStorage.removeItem('selectedVoiceName');
          window.selectedVoice = null;
        }
        
        // Save speech rate
        localStorage.setItem('speechRate', speechRateSelect.value);
        if (window.speechRate !== undefined) {
          window.speechRate = parseFloat(speechRateSelect.value);
        }
        
        console.log('Auto-saved voice settings (silent):', {
          voiceIndex: voiceSelect.selectedIndex,
          originalIndex: selectedOption.dataset.originalIndex,
          voiceName: voiceSelect.value,
          speechRate: speechRateSelect.value
        });
      }
    }

    // Voice settings functionality
    function saveVoiceSettings() {
      const voiceSelect = document.getElementById('voiceSelect');
      const speechRateSelect = document.getElementById('speechRateSelect');
      const statusDiv = document.getElementById('saveStatus');
      
      // Get the original voice index from the selected option's data attribute
      const selectedOption = voiceSelect.options[voiceSelect.selectedIndex];
      let originalVoiceIndex = null;
      let selectedVoice = null;
      
      if (voiceSelect.selectedIndex > 0) { // Not "Choose voice" option
        originalVoiceIndex = parseInt(selectedOption.dataset.originalIndex);
        const voices = window.speechSynthesis.getVoices();
        selectedVoice = voices[originalVoiceIndex];
        
        // Save the original voice index and name
        localStorage.setItem('selectedVoiceIndex', originalVoiceIndex);
        localStorage.setItem('selectedVoiceName', selectedVoice.name);
        
        // Update global variables
        window.selectedVoice = selectedVoice;
      } else {
        // "Choose voice" selected - clear selection
        localStorage.removeItem('selectedVoiceIndex');
        localStorage.removeItem('selectedVoiceName');
        window.selectedVoice = null;
      }
      
      // Save speech rate
      localStorage.setItem('speechRate', speechRateSelect.value);
      if (window.speechRate !== undefined) {
        window.speechRate = parseFloat(speechRateSelect.value);
      }
      
      // Voice confirmation using the correct voice (only speak once)
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                    (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      
      if (selectedVoice) {
        // Clear any pending speech to prevent conflicts
        window.speechSynthesis.cancel();
        
        const confirmationText = `Voice settings saved. You have selected ${selectedVoice.name.split(' ')[0]}`;
        const utterance = new SpeechSynthesisUtterance(confirmationText);
        utterance.voice = selectedVoice;
        utterance.rate = parseFloat(speechRateSelect.value);
        utterance.lang = "en-US"; // Force English
        
        // Small delay to ensure speech synthesis is ready
        setTimeout(() => {
          window.speechSynthesis.speak(utterance);
        }, 100);
        
        console.log(`üîä Voice confirmation: "${confirmationText}" using voice: ${selectedVoice.name} (${selectedVoice.lang})`);
      }
      
      // Show success message
      statusDiv.textContent = "Voice settings saved successfully!";
      statusDiv.className = "status-message success";
      statusDiv.style.display = "block";
      
      // Hide message after 3 seconds
      setTimeout(() => {
        statusDiv.style.display = "none";
      }, 3000);
    }

    // Load saved settings when page loads
    function loadVoiceSettings() {
      const savedVoiceIndex = localStorage.getItem('selectedVoiceIndex');
      const savedSpeechRate = localStorage.getItem('speechRate');
      
      if (savedSpeechRate) {
        document.getElementById('speechRateSelect').value = savedSpeechRate;
      }
      
      // Wait for voices to load, then set saved voice
      if (savedVoiceIndex) {
        const checkVoices = () => {
          const voices = speechSynthesis.getVoices();
          if (voices.length > 0) {
            const voiceSelect = document.getElementById('voiceSelect');
            if (savedVoiceIndex < voices.length) {
              voiceSelect.selectedIndex = savedVoiceIndex;
            }
          } else {
            setTimeout(checkVoices, 100);
          }
        };
        checkVoices();
      }
    }

    // Check notification status
    function checkNotificationStatus() {
      const statusSpan = document.getElementById('notificationStatus');
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                    (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      
      if (isIOS) {
        if (window.oneSignalEnabled) {
          statusSpan.textContent = "iOS notifications active (OneSignal)";
        } else if (window.iosNativeNotificationsAvailable && Notification.permission === 'granted') {
          statusSpan.textContent = "iOS notifications active (Native Web Push)";
        } else if (window.iosNativeNotificationsAvailable) {
          statusSpan.textContent = "iOS native notifications available - permission needed";
        } else {
          statusSpan.textContent = "iOS notifications pending setup";
        }
      } else {
        if (Notification && Notification.permission === 'granted') {
          statusSpan.textContent = "Desktop notifications enabled";
        } else if (Notification && Notification.permission === 'denied') {
          statusSpan.textContent = "Desktop notifications blocked";
        } else {
          statusSpan.textContent = "Desktop notifications not configured";
        }
      }
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
      loadVoiceSettings();
      setTimeout(checkNotificationStatus, 1000); // Give time for OneSignal to load
      
      // Setup notification checkbox handler
      setupNotificationCheckbox();
    });
    
    // Handle notification checkbox
    function setupNotificationCheckbox() {
      const checkbox = document.getElementById('enableNotifications');
      const statusSpan = document.getElementById('notificationStatus');
      
      if (!checkbox) return;
      
      // Check initial state based on current permissions
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      
      if (isIOS) {
        // For iOS, check if OneSignal is enabled and subscribed
        if (window.OneSignal) {
          OneSignal.getSubscription().then(function(subscription) {
            checkbox.checked = !!subscription;
          });
        }
      } else {
        // For desktop, check native notification permission
        checkbox.checked = Notification && Notification.permission === 'granted';
      }
      
      // Handle checkbox change
      checkbox.addEventListener('change', function() {
        if (this.checked) {
          triggerNotificationPrompt();
        } else {
          // If unchecked, just update status (can't really disable notifications once granted)
          statusSpan.textContent = "Notifications disabled by user";
        }
      });
    }
    
    // Trigger notification permission prompt
    function triggerNotificationPrompt() {
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      const statusSpan = document.getElementById('notificationStatus');
      const checkbox = document.getElementById('enableNotifications');
      
      if (isIOS) {
        // For iOS, try OneSignal first, fallback to native
        if (window.OneSignal) {
          console.log('Triggering OneSignal permission prompt...');
          
          // Check if we're on HTTPS or localhost
          const isSecure = window.location.protocol === 'https:' || 
                          window.location.hostname === 'localhost' || 
                          window.location.hostname === '127.0.0.1';
          
          if (!isSecure) {
            statusSpan.textContent = "Notifications require HTTPS on iOS";
            checkbox.checked = false;
            return;
          }
          
          // Force OneSignal to show permission prompt
          OneSignal.showSlidedownPrompt().then(function() {
            console.log('OneSignal slidedown prompt shown');
          }).catch(function(error) {
            console.log('OneSignal slidedown prompt error:', error);
            
            // Fallback: try direct notification prompt
            OneSignal.showNativePrompt().then(function() {
              console.log('OneSignal native prompt shown');
            }).catch(function(nativeError) {
              console.log('OneSignal native prompt error:', nativeError);
              // Final fallback: try iOS native notifications
              tryIOSNativeNotifications();
            });
          });
          
          // Check subscription status after prompt
          setTimeout(() => {
            OneSignal.getSubscription().then(function(subscription) {
              if (subscription) {
                statusSpan.textContent = "iOS notifications enabled (OneSignal)";
                checkbox.checked = true;
              } else {
                statusSpan.textContent = "iOS notifications denied or cancelled";
                checkbox.checked = false;
                // Try iOS native as fallback
                tryIOSNativeNotifications();
              }
            });
          }, 2000);
          
        } else {
          // OneSignal not available, try iOS native notifications
          tryIOSNativeNotifications();
        }
      } else {
        // For desktop, use native notifications
        if (Notification) {
          console.log('Current permission:', Notification.permission);
          
          if (Notification.permission === 'default') {
            console.log('Requesting desktop notification permission...');
            Notification.requestPermission().then(function(permission) {
              console.log('Permission result:', permission);
              if (permission === 'granted') {
                statusSpan.textContent = "Desktop notifications enabled";
                checkbox.checked = true;
                
                // Show test notification
                setTimeout(() => {
                  new Notification('TaskMaster Pro', {
                    body: 'Notifications enabled! You\'ll get reminders when tasks are due.',
                    icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHZpZXdCb3g9IjAgMCA0OCA0OCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHJ4PSIxMiIgZmlsbD0iIzRmNDZlNSIvPgogIDxwYXRoIGQ9Ik0xOCAyNGw0IDRsOC04IiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjMiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8L3N2Zz4K'
                  });
                }, 500);
              } else {
                statusSpan.textContent = "Desktop notifications denied";
                checkbox.checked = false;
              }
            });
          } else if (Notification.permission === 'granted') {
            statusSpan.textContent = "Desktop notifications already enabled";
            checkbox.checked = true;
          } else {
            statusSpan.textContent = "Notifications denied - check browser settings";
            checkbox.checked = false;
          }
        } else {
          statusSpan.textContent = "Notifications not supported in this browser";
          checkbox.checked = false;
        }
      }
    }
    
    // iOS Native Notification Fallback Function
    function tryIOSNativeNotifications() {
      const statusSpan = document.getElementById('notificationStatus');
      const checkbox = document.getElementById('enableNotifications');
      
      console.log('üçé Attempting iOS native notifications fallback...');
      
      // Check if iOS native notifications are available
      if (window.iosNativeNotificationsAvailable && 'Notification' in window) {
        if (Notification.permission === 'default') {
          console.log('üì± Requesting iOS native notification permission...');
          Notification.requestPermission().then(function(permission) {
            console.log('üì± iOS native permission result:', permission);
            if (permission === 'granted') {
              statusSpan.textContent = "iOS notifications enabled (Native Web Push)";
              checkbox.checked = true;
              window.iosNativeEnabled = true;
              
              // Show test notification
              setTimeout(() => {
                new Notification('TaskMaster Pro - iOS Native', {
                  body: 'Native iOS notifications enabled! You\'ll get reminders when tasks are due.',
                  icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHZpZXdCb3g9IjAgMCA0OCA0OCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHJ4PSIxMiIgZmlsbD0iIzRmNDZlNSIvPgogIDxwYXRoIGQ9Ik0xOCAyNGw0IDRsOC04IiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjMiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8L3N2Zz4K'
                });
              }, 500);
            } else {
              statusSpan.textContent = "iOS native notifications denied";
              checkbox.checked = false;
            }
          });
        } else if (Notification.permission === 'granted') {
          statusSpan.textContent = "iOS notifications already enabled (Native)";
          checkbox.checked = true;
          window.iosNativeEnabled = true;
        } else {
          statusSpan.textContent = "iOS notifications denied - check Safari settings";
          checkbox.checked = false;
        }
      } else {
        statusSpan.textContent = "iOS native notifications not supported (requires iOS 16.4+)";
        checkbox.checked = false;
      }
    }
  </script>

</body>
</html>