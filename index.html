<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TaskMaster Pro</title>
  
  <!-- External Styles -->
  <link rel="stylesheet" href="styles.css" />
  
  <!-- PWA Meta Tags -->
  <meta name="description" content="TaskMaster Pro - Master your tasks, dominate your day with advanced reminders and notifications" />
  <meta name="theme-color" content="#4f46e5" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="TaskMaster Pro" />
  <meta name="msapplication-TileColor" content="#4f46e5" />
  <meta name="msapplication-config" content="browserconfig.xml" />
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="./manifest.json" />
  
  <!-- OneSignal for iOS notifications -->
  <script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async=""></script>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  
  <!-- Favicon and App Icons -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHZpZXdCb3g9IjAgMCA0OCA0OCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHJ4PSIxMiIgZmlsbD0iIzRmNDZlNSIvPgogIDxwYXRoIGQ9Ik0xOCAyNGw0IDRsOC04IiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjMiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8L3N2Zz4K" />
  <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiAgPHJlY3Qgd2lkdGg9IjE5MiIgaGVpZ2h0PSIxOTIiIHJ4PSI0OCIgZmlsbD0iIzRmNDZlNSIvPgogIDxwYXRoIGQ9Ik03MiA5NmwxNiAxNmwzMi0zMiIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIxMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+Cjwvc3ZnPgo=" />
</head>
<body>
  <!-- Welcome Message (shown when logged in) -->
  <div id="welcome-message" style="display: none; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 15px 20px; text-align: center; font-weight: 600; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
    Welcome, <span id="username"></span>!
    <button onclick="signOut()" style="margin-left: 20px; background: rgba(255,255,255,0.2); border: 1px solid white; color: white; padding: 6px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">Sign Out</button>
  </div>
  
  <!-- Guest Mode Notice (shown when not logged in) -->
  <div id="guest-notice" style="display: none; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 12px 20px; text-align: center; font-size: 14px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
    Guest Mode: Your data will be deleted after 2 hours. <a href="account.html" style="color: white; text-decoration: underline; font-weight: 600;">Create an account</a> to save forever!
  </div>
  
  <!-- Hero Section -->
  <div class="hero">
    <h1>TaskMaster Pro</h1>
    <p>Master your tasks, dominate your day with advanced reminders and notifications</p>
    
    <!-- Main Navigation -->
    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="options.html">Options</a></li>
      <li><a href="taskmaster.html">Your Lists</a></li>
      <li><a href="list.html">Create List</a></li>
      <li id="account-link"><a href="account.html">Create Account</a></li>
      <li id="admin-link" style="display: none;"><a href="admin.html" style="color: #f59e0b; font-weight: 700;">Admin Dashboard</a></li>
    </ul>
  </div>

  <!-- Features Section -->
  <div class="features">
    <h2>Why Choose TaskMaster Pro?</h2>
    <div class="feature-grid">
      <div class="feature">
        <div class="icon">NOTIFY</div>
        <h3>Smart Notifications</h3>
        <p>Cross-platform notifications that work on iOS, Android, and desktop. Never miss a deadline again.</p>
      </div>
      
      <div class="feature">
        <div class="icon">VOICE</div>
        <h3>Voice Feedback</h3>
        <p>Customizable voice announcements with multiple voices and speeds. Perfect for accessibility and multitasking.</p>
      </div>
      
      <div class="feature">
        <div class="icon">PWA</div>
        <h3>Progressive Web App</h3>
        <p>Install on your device like a native app. Works offline and provides a seamless experience across platforms.</p>
      </div>
      
      <div class="feature">
        <div class="icon">REMIND</div>
        <h3>Flexible Reminders</h3>
        <p>Set custom reminder times from minutes to years in advance. Get notified exactly when you need it.</p>
      </div>
      
      <div class="feature">
        <div class="icon">ORGANIZE</div>
        <h3>Smart Categories</h3>
        <p>Organize tasks into categories like Blogging, YouTube, School, and more. Stay focused on what matters.</p>
      </div>
      
      <div class="feature">
        <div class="icon">SECURE</div>
        <h3>Auto-Save</h3>
        <p>Your tasks are automatically saved locally. No account required, your data stays private and secure.</p>
      </div>
    </div>
  </div>

  <script src="todo.js"></script>
  
  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyC1S6U4E_IIAw5csnapl8ZoIyBS_Lv5k2A",
      authDomain: "taskmaster-pro-bf98a.firebaseapp.com",
      projectId: "taskmaster-pro-bf98a",
      storageBucket: "taskmaster-pro-bf98a.firebasestorage.app",
      messagingSenderId: "47778628154",
      appId: "1:47778628154:web:eddd6a64147d917fcb6b03",
      measurementId: "G-JERNL4E72Z"
    };

    // Initialize Firebase
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Set auth persistence to LOCAL (persists even when browser is closed)
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch((error) => {
      console.error('Error setting auth persistence:', error);
    });

    // Check authentication state
    auth.onAuthStateChanged((user) => {
      const welcomeMsg = document.getElementById('welcome-message');
      const guestNotice = document.getElementById('guest-notice');
      const usernameEl = document.getElementById('username');
      const accountLink = document.getElementById('account-link');
      const adminLink = document.getElementById('admin-link');
      
      if (user) {
        // User is signed in
        const displayName = user.displayName || user.email.split('@')[0];
        if (usernameEl) usernameEl.textContent = displayName;
        if (welcomeMsg) welcomeMsg.style.display = 'block';
        if (guestNotice) guestNotice.style.display = 'none';
        if (accountLink) accountLink.style.display = 'none';
        
        // Show admin link if user is admin
        if (adminLink) {
          const userEmail = user.email ? user.email.toLowerCase().trim() : '';
          const adminEmail = 'fluffyfighter23@gmx.de';
          if (userEmail === adminEmail) {
            adminLink.style.display = 'list-item';
          }
        }
        
        // Store user info globally
        window.currentUser = user;
        window.isGuestMode = false;
        
        // Set user presence to online
        setUserPresence(user, true);
      } else {
        // User is not signed in (guest mode)
        if (welcomeMsg) welcomeMsg.style.display = 'none';
        if (guestNotice) guestNotice.style.display = 'block';
        if (accountLink) accountLink.style.display = 'list-item';
        
        window.currentUser = null;
        window.isGuestMode = true;
        
        // Set up guest mode - data expires in 2 hours
        setupGuestMode();
      }
    });

    // Set user presence
    function setUserPresence(user, online) {
      if (!user) return Promise.resolve();
      
      const presenceRef = db.collection('presence').doc(user.uid);
      
      if (online) {
        // Set user as online
        return presenceRef.set({
          online: true,
          username: user.displayName || user.email.split('@')[0],
          email: user.email,
          lastSeen: firebase.firestore.FieldValue.serverTimestamp()
        }).catch(error => console.error('Error setting presence:', error));
      } else {
        // Set user as offline
        return presenceRef.update({
          online: false,
          lastSeen: firebase.firestore.FieldValue.serverTimestamp()
        }).catch(error => console.error('Error updating presence:', error));
      }
    }
    
    // Heartbeat: Update lastSeen every 30 seconds
    let heartbeatInterval;
    
    // Set up heartbeat when user signs in
    auth.onAuthStateChanged((user) => {
      // Clear any existing heartbeat
      if (heartbeatInterval) clearInterval(heartbeatInterval);
      
      if (user) {
        // Set up heartbeat to update lastSeen every 30 seconds
        heartbeatInterval = setInterval(() => {
          db.collection('presence').doc(user.uid).update({
            lastSeen: firebase.firestore.FieldValue.serverTimestamp()
          }).catch(error => console.error('Heartbeat error:', error));
        }, 30000);
      }
    });
    
    // Mark user offline when closing tab/browser (best effort)
    window.addEventListener('beforeunload', () => {
      const user = auth.currentUser;
      if (user) {
        db.collection('presence').doc(user.uid).update({
          online: false,
          lastSeen: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
    });

    // Sign out function
    async function signOut() {
      const user = auth.currentUser;
      if (user) {
        // Wait for presence to be updated before signing out
        await setUserPresence(user, false);
      }
      
      auth.signOut().then(() => {
        alert('You have been signed out successfully!');
        window.location.reload();
      }).catch((error) => {
        console.error('Sign out error:', error);
        alert('Error signing out: ' + error.message);
      });
    }

    // Guest mode setup - auto-delete data after 2 hours
    function setupGuestMode() {
      const guestStartTime = localStorage.getItem('guestModeStartTime');
      const now = Date.now();
      const twoHours = 2 * 60 * 60 * 1000; // 2 hours in milliseconds
      
      if (!guestStartTime) {
        // First time in guest mode, set start time
        localStorage.setItem('guestModeStartTime', now.toString());
      } else {
        // Check if 2 hours have passed
        const elapsed = now - parseInt(guestStartTime);
        if (elapsed >= twoHours) {
          // Clear all guest data
          clearGuestData();
          localStorage.setItem('guestModeStartTime', now.toString());
        }
      }
      
      // Set up periodic check every minute
      setInterval(() => {
        const startTime = parseInt(localStorage.getItem('guestModeStartTime'));
        const currentTime = Date.now();
        if (currentTime - startTime >= twoHours) {
          clearGuestData();
          localStorage.setItem('guestModeStartTime', currentTime.toString());
          alert('Your guest session expired. Your data has been cleared.');
          window.location.reload();
        }
      }, 60000); // Check every minute
    }

    // Clear guest data
    function clearGuestData() {
      // Keep only essential settings, clear tasks and lists
      const keysToKeep = ['voiceEnabled', 'selectedVoice', 'voiceSpeed', 'notificationsEnabled', 'guestModeStartTime'];
      const allKeys = Object.keys(localStorage);
      
      allKeys.forEach(key => {
        if (!keysToKeep.includes(key)) {
          localStorage.removeItem(key);
        }
      });
    }
  </script>
</body>
</html>
